---
interface Props {
  chartId: string;
  title: string;
  timeRange: number;
}

const { chartId, title, timeRange } = Astro.props;
---

<div class="chart-container">
  <div class="chart-header">
    <h3 class="chart-title">{title}</h3>
    <div class="chart-controls">
      <select class="form-select" id={`${chartId}TimeRange`} name={`${chartId}TimeRange`}>
        <option value="7">7 days</option>
        <option value="14">14 days</option>
        <option value="30">30 days</option>
        <option value="60">60 days</option>
        <option value="120">120 days</option>
        <option value="365">365 days</option>
      </select>
    </div>
  </div>
  <div class="chart-body" style="height: 280px; position: relative;">
    <canvas id={chartId}></canvas>
  </div>
</div>

<script define:vars={{ chartId, title, timeRange }}>
  let chartInstance = null;

  async function fetchChartData(url, chartId, datasetLabel) {
    try {
      const response = await fetch(url);
      const data = await response.json();
      const ctx = document.getElementById(chartId)?.getContext('2d');
      if (!ctx) return;

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
          maintainAspectRatio: false,
          responsive: true,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#9898a8',
                font: { weight: '500', size: 11, family: 'Inter' },
                padding: 16,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(15, 15, 30, 0.95)',
              titleColor: '#e8e8f0',
              bodyColor: '#b0b0c0',
              borderColor: 'rgba(139, 92, 246, 0.2)',
              borderWidth: 1,
              cornerRadius: 8,
              padding: 12,
              displayColors: true,
              callbacks: {
                label: (t) => `${datasetLabel}: ${t.raw}`
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { color: '#5a5a6e', font: { size: 10, family: 'Inter' } },
              grid: { color: 'rgba(139, 92, 246, 0.06)', drawBorder: false },
              border: { display: false }
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#5a5a6e', font: { size: 10, family: 'Inter' } },
              grid: { color: 'rgba(139, 92, 246, 0.06)', drawBorder: false },
              border: { display: false }
            }
          },
          elements: {
            line: { tension: 0.35, borderWidth: 2 },
            point: { radius: 2, hoverRadius: 5, borderWidth: 2, backgroundColor: '#0f0f1e' }
          }
        }
      });
    } catch (error) {
      console.error(`Failed to load chart data for ${chartId}:`, error);
      const canvas = document.getElementById(chartId);
      if (canvas?.parentElement) {
        canvas.parentElement.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#5a5a6e;">
            <div style="text-align:center">
              <p style="font-size:0.85rem;">Failed to load chart</p>
              <button class="btn btn-ghost btn-sm" style="margin-top:0.5rem" onclick="location.reload()">Retry</button>
            </div>
          </div>`;
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const sel = document.getElementById(`${chartId}TimeRange`);
    const container = document.getElementById(chartId)?.parentElement;
    if (!sel) return;

    function showLoading() {
      if (container) container.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#5a5a6e;"><p style="font-size:0.85rem;">Loading...</p></div>`;
    }

    function resetChart() {
      if (container) container.innerHTML = `<canvas id="${chartId}"></canvas>`;
    }

    async function updateChart() {
      sel.disabled = true;
      showLoading();
      try {
        resetChart();
        await fetchChartData(`/api/admin/${chartId}Chart?timeRange=${sel.value}`, chartId, `Total ${title.replace(' Over Time', '')}`);
      } finally { sel.disabled = false; }
    }

    sel.addEventListener('change', updateChart);
    sel.value = timeRange.toString();
    updateChart();
  });
</script>
