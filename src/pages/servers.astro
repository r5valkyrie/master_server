---
import Main from '../layouts/Main.astro';
---
<Main>
  <div class="refresh-servers-container">
    <button id="refresh-servers-btn" class="refresh-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
      <span>Refresh</span>
    </button>
  </div>
  <div class="servers-container fade-in-on-scroll">
    <aside class="filters-sidebar">
      <div class="filter-group">
        <label for="search-input">Search servers...</label>
        <input type="text" id="search-input" placeholder="Search servers...">
      </div>
      <div class="filter-group">
        <label for="regions">Regions:</label>
        <select id="regions" name="regions">
          <option value="all">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="gamemodes">Gamemodes:</label>
        <select id="gamemodes" name="gamemodes">
          <option value="all">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="maps">Maps:</label>
        <select id="maps" name="maps">
          <option value="all">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="mods">Mods:</label>
        <select id="mods" name="mods">
          <option value="all">All</option>
        </select>
      </div>
      <div class="filter-group checkboxes">
        <div>
          <input type="checkbox" id="include-full" checked>
          <label for="include-full">Include full</label>
        </div>
        <div>
          <input type="checkbox" id="include-empty" checked>
          <label for="include-empty">Include empty</label>
        </div>
      </div>
      <div class="sidebar-footer">
        <p>Last updated: <span id="last-updated">...</span></p>
        <p><span id="server-count">...</span> servers listed</p>
        <p><span id="player-count">...</span> players listed</p>
      </div>
    </aside>
    <div class="servers-content">
      <table>
        <thead>
          <tr>
            <th></th> <!-- Lock icon -->
            <th>Region</th>
            <th>Name</th>
            <th>Players</th>
            <th>Gamemode</th>
            <th>Map</th>
            <th>Required Mods</th>
          </tr>
        </thead>
        <tbody id="servers-table-body">
          <tr class="loading-row" style="display: none;">
            <td colspan="7" style="text-align: center;">
              <div class="loader"></div>
            </td>
          </tr>
          <tr class="no-servers-row" style="display: none;">
            <td colspan="7" style="text-align: center;">No servers found.</td>
          </tr>
          <!-- Server rows will be dynamically inserted here -->
        </tbody>
      </table>
    </div>
  </div>
</Main>

<style>
  .lock-icon {
    margin-right: 5px;
    vertical-align: middle;
    display: inline-block;
  }
</style>

<script>
  function GetGamemode(playlist: string): string {
    switch (playlist) {
      case "fs_dm": return "TDM";
      case "fs_prophunt": return "Prophunt";
      case "fs_1v1": return "1v1";
      case "fs_duckhunt": return "Duckhunt";
      case "fs_mantlejumppractice": return "Mantle Jump";
      case "fs_infected": return "Infected";
      case "custom_tdm": return "TDM";
      case "custom_ctf": return "Capture The Flag";
      case "survival": return "Battle Royal";
      case "fs_movementgym": return "Movement Gym";
      case "fs_survival_solos": return "BR Solo";
      default: return playlist;
    }
  }

  function GetMapName(mapname: string): string {
    switch (mapname) {
      case "mp_rr_canyonlands_staging": return "Firing Range";
      case "mp_rr_aqueduct": return "Overflow";
      case "mp_rr_aqueduct_night": return "Overflow After Dark";
      case "mp_rr_ashs_redemption": return "Ashs Redemption";
      case "mp_rr_canyonlands_64k_x_64k": return "Kings Canyon S1";
      case "mp_rr_canyonlands_mu1": return "Kings Canyon S2";
      case "mp_rr_canyonlands_mu1_night": return "Kings Canyon S2 After Dark";
      case "mp_rr_desertlands_64k_x_64k": return "Worlds Edge";
      case "mp_rr_desertlands_64k_x_64k_nx": return "Worlds Edge After Dark";
      case "mp_rr_desertlands_64k_x_64k_tt": return "Worlds Edge Mirage Voyage";
      case "mp_rr_arena_composite": return "Drop Off";
      case "mp_rr_arena_skygarden": return "Encore";
      case "mp_rr_party_crasher": return "Party Crasher";
      case "mp_lobby": return "Lobby";
      default: return mapname;
    }
  }

  async function fetchServers() {
    const tableBody = document.getElementById('servers-table-body');
    const loadingRow = document.querySelector('.loading-row') as HTMLElement;
    const noServersRow = document.querySelector('.no-servers-row') as HTMLElement;

    if (!tableBody || !loadingRow || !noServersRow) return;

    // Show loader and hide other messages
    loadingRow.style.display = '';
    noServersRow.style.display = 'none';
    const serverRows = tableBody.querySelectorAll('tr.server-row');
    serverRows.forEach(row => row.remove());
    
    const response = await fetch('/api/servers', {
      method: 'POST',
      body: JSON.stringify({}),
      headers: { 'Content-Type': 'application/json' }
    });
    const { servers } = await response.json();
    
    // Hide loader
    loadingRow.style.display = 'none';

    const serverCount = document.getElementById('server-count');
    const playerCount = document.getElementById('player-count');
    const lastUpdated = document.getElementById('last-updated');

    if (!serverCount || !playerCount || !lastUpdated) return;

    let totalPlayers = 0;
    let totalMaxPlayers = 0;

    if (servers.length === 0) {
      noServersRow.style.display = '';
    } else {
      servers.forEach((server: any) => {
        totalPlayers += server.playerCount;
        totalMaxPlayers += server.maxPlayers;

        const joinButtonHTML = server.playlist === 'discord.gg/GcJSMUGJyD' 
          ? '' 
          : `<a href="r5valk://join?ip=${server.ip}&port=${server.port}" class="join-btn">Join</a>`;

        const passwordIcon = server.hasPassword 
          ? `<svg class="lock-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`
          : '';

        // Normalize requiredMods: backend may return JSON string or array
        let requiredMods: string[] = [];
        if (Array.isArray(server.requiredMods)) {
          requiredMods = server.requiredMods.filter((m: any) => typeof m === 'string' && m.trim().length > 0);
        } else if (typeof server.requiredMods === 'string') {
          try {
            const parsed = JSON.parse(server.requiredMods);
            if (Array.isArray(parsed)) {
              requiredMods = parsed.filter((m: any) => typeof m === 'string' && m.trim().length > 0);
            }
          } catch {}
        }
        const requiredModsText = requiredMods.length > 0 ? requiredMods.join(', ') : '-';

        const row = document.createElement('tr');
        row.className = 'server-row';
        row.dataset.name = server.name.toLowerCase();
        const rowHTML = `
            <td>${passwordIcon}</td>
            <td>${server.region || 'N/A'}</td>
            <td>${server.name}</td>
            <td>${server.playerCount}/${server.maxPlayers}</td>
            <td>${GetGamemode(server.playlist)}</td>
            <td>${GetMapName(server.map)}</td>
            <td>${requiredModsText}</td>
        `;
        row.innerHTML = rowHTML;
        tableBody.appendChild(row);
      });
    }
    
    serverCount.textContent = `${servers.length} / ${servers.length}`;
    playerCount.textContent = `${totalPlayers} / ${totalMaxPlayers}`;
    lastUpdated.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  function filterServers() {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    if (!searchInput) return;
    const filter = searchInput.value.toLowerCase();
    const rows = document.querySelectorAll('.server-row');
    const noServersRow = document.querySelector('.no-servers-row') as HTMLElement;
    if (!noServersRow) return;

    let visibleRows = 0;
    rows.forEach(row => {
      const name = (row as HTMLElement).dataset.name;
      if (name && name.includes(filter)) {
        (row as HTMLElement).style.display = '';
        visibleRows++;
      } else {
        (row as HTMLElement).style.display = 'none';
      }
    });

    if (rows.length > 0) {
      noServersRow.style.display = visibleRows > 0 ? 'none' : '';
    }
  }

  function initializeServersPage() {
    // Guard to ensure this only runs on the servers page
    if (!document.getElementById('servers-table-body')) return;

    fetchServers();
    const searchInput = document.getElementById('search-input');
    if(searchInput) {
        searchInput.addEventListener('keyup', filterServers);
    }
    const refreshBtn = document.getElementById('refresh-servers-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', fetchServers);
    }
  }

  // Run on initial page load
  initializeServersPage();

  // Run on subsequent page loads
  document.addEventListener('astro:after-swap', initializeServersPage);
</script>