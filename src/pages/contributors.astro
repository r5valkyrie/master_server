---
import Main from "../layouts/Main.astro";

const GITHUB_REPO = "r5valkyrie/docs";
const GITHUB_BRANCH = "main";
const GITHUB_CONTRIBUTORS_PATH = "contributors";

// Fix GitHub blob URLs to raw URLs to avoid CORS issues
function normalizeGitHubUrl(url: string): string {
	if (!url) return url;
	
	// Convert github.com/user/repo/blob/branch/path?raw=true to raw.githubusercontent.com/user/repo/branch/path
	const blobMatch = url.match(/^https?:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+?)(\?raw=true)?$/);
	if (blobMatch) {
		const [, user, repo, branch, path] = blobMatch;
		return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}`;
	}
	
	return url;
}

async function fetchContributors(fileName: string) {
	const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/${GITHUB_BRANCH}/${GITHUB_CONTRIBUTORS_PATH}/${fileName}`;
	try {
		const response = await fetch(url);
		if (!response.ok) {
			console.error(
				`Failed to fetch ${fileName}. Status: ${response.status}`,
			);
			return [];
		}
		const contributors = await response.json();
		// Normalize avatar URLs
		return contributors.map((c: any) => ({
			...c,
			avatar: normalizeGitHubUrl(c.avatar)
		}));
	} catch (error) {
		console.error(`Error fetching ${fileName}:`, error);
		return [];
	}
}

const [valkyrieContributors, r5reloadedContributors] = await Promise.all([
	fetchContributors("contributors.json"),
	fetchContributors("r5reloaded_contributors.json"),
]);
---

<Main title="Contributors">
	<div class="container page-container fade-in">
		<div class="page-header centered">
			<h1>Contributors</h1>
			<p class="subtitle">
				The amazing people who make this project possible
			</p>
		</div>

		<section class="contributors-section">
			<h2>R5Valkyrie Team</h2>
			<div class="contributors-grid">
				{
					valkyrieContributors.map((contributor: any) => (
						<a
							href={contributor.url}
							target="_blank"
							class="contributor-card"
						>
							<div class="avatar-wrapper">
								<img
									src={contributor.avatar}
									alt={contributor.name}
									loading="lazy"
									crossorigin="anonymous"
								/>
							</div>
							<div class="contributor-info">
								<h3>{contributor.name}</h3>
								<span class="role">
									{contributor.description || "Contributor"}
								</span>
							</div>
						</a>
					))
				}
			</div>
		</section>

		<section class="contributors-section">
			<h2>R5Reloaded Contributors</h2>
			<div class="contributors-grid">
				{
					r5reloadedContributors.map((contributor: any) => (
						<a
							href={contributor.url}
							target="_blank"
							class="contributor-card"
						>
							<div class="avatar-wrapper">
								<img
									src={contributor.avatar}
									alt={contributor.name}
									loading="lazy"
									crossorigin="anonymous"
								/>
							</div>
							<div class="contributor-info">
								<h3>{contributor.name}</h3>
								<span class="role">
									{contributor.description || "Contributor"}
								</span>
							</div>
						</a>
					))
				}
			</div>
		</section>
	</div>
</Main>

<style>
	.page-container {
		padding-top: 40px;
	}

	.page-header.centered {
		text-align: center;
		margin-bottom: 60px;
	}

	.subtitle {
		color: var(--text-muted);
		font-size: 1.2rem;
		margin-top: 10px;
	}

	.contributors-section {
		margin-bottom: 80px;
	}

	.contributors-section h2 {
		font-size: 1.8rem;
		margin-bottom: 30px;
		padding-bottom: 10px;
		border-bottom: 1px solid var(--border-light);
	}

	.contributors-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
		gap: 24px;
	}

	.contributor-card {
		background: var(--bg-card);
		border: 1px solid var(--border-light);
		border-radius: var(--radius-lg);
		padding: 24px;
		display: flex;
		flex-direction: column;
		align-items: center;
		text-align: center;
		transition: all 0.3s ease;
		text-decoration: none;
	}

	.contributor-card:hover {
		transform: translateY(-4px);
		background: var(--bg-card-hover);
		border-color: var(--border-hover);
		box-shadow: var(--shadow-sm);
	}

	.avatar-wrapper {
		width: 80px;
		height: 80px;
		border-radius: 50%;
		overflow: hidden;
		margin-bottom: 16px;
		border: 2px solid var(--border-light);
		background: rgba(0, 0, 0, 0.2);
	}

	.avatar-wrapper img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.contributor-info h3 {
		font-size: 1.1rem;
		margin-bottom: 4px;
		color: var(--text-main);
	}

	.role {
		font-size: 0.85rem;
		color: var(--text-muted);
		background: rgba(255, 255, 255, 0.05);
		padding: 4px 10px;
		border-radius: var(--radius-full);
	}
</style>
