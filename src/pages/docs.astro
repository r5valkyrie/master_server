---
import Main from '../layouts/Main.astro';
import { marked } from 'marked';
import fs from 'fs/promises';
import path from 'path';

const GITHUB_REPO = 'r5valkyrie/docs';
const GITHUB_BRANCH = 'main';
const GITHUB_DOCS_PATH = 'docs';

async function fetchFromGitHub(file: string) {
    const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/${GITHUB_BRANCH}/${GITHUB_DOCS_PATH}/${file}?t=${Date.now()}`;
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error(`Failed to fetch ${file} from GitHub`);
    }
    return response.text();
}

async function fetchFromLocal(file: string) {
    const filePath = path.join(process.cwd(), 'docs', file);
    try {
        return await fs.readFile(filePath, 'utf-8');
    } catch (error) {
        return `# Error\n\nCould not load content for this page.`;
    }
}

const sidebarConfigPromise = fetchFromGitHub('sidebar.json').then(res => JSON.parse(res));

const sidebarConfig = await sidebarConfigPromise;
const sidebar = sidebarConfig.sidebar;

const url = new URL(Astro.request.url);
const pageSlug = url.searchParams.get('page') || sidebarConfig.startPage;

// Validate pageSlug to prevent path traversal - only allow alphanumeric, hyphens, underscores
if (!/^[a-zA-Z0-9_-]+$/.test(pageSlug)) {
    throw new Error('Invalid page slug');
}

const contentPromise = fetchFromGitHub(`${pageSlug}.md`);

const content = await contentPromise;

const htmlContent = marked(content);
---

<Main>
    <div class="docs-container docs-page">
        <aside class="docs-sidebar fade-in-on-scroll">
            <nav>
                {sidebar.map((section: any) => (
                    <div class="sidebar-section">
                        <h3>{section.title}</h3>
                        <ul>
                            {section.pages.map((page: any) => (
                                <li>
                                    <a href={`/docs?page=${encodeURIComponent(page.slug)}`} class={page.slug === pageSlug ? 'active' : ''}>
                                        {page.title}
                                    </a>
                                </li>
                            ))}
                        </ul>
                    </div>
                ))}
            </nav>
        </aside>
        <main class="docs-content fade-in-on-scroll" set:html={htmlContent} />
        <div class="page-loader" aria-hidden="true"><div class="loader"></div></div>
    </div>
</Main>

<script>
    function setupDocsLoading() {
        const root = document.querySelector('.docs-page');
        const links = document.querySelectorAll('.docs-sidebar a');
        links.forEach((link) => {
            link.addEventListener('click', () => {
                root?.classList.add('is-loading');
            });
        });
        document.addEventListener('astro:page-load', () => {
            const newRoot = document.querySelector('.docs-page');
            newRoot?.classList.remove('is-loading');
        });
    }

    function slugify(text: string) {
        return text
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-');
    }

    function enhanceDocsContent() {
        const container = document.querySelector('.docs-content');
        if (!container) return;

        // Add heading anchors
        const headings = container.querySelectorAll('h2, h3, h4');
        headings.forEach((heading) => {
            if (!heading.id) {
                const base = slugify(heading.textContent || '');
                if (base) heading.id = base;
            }
            if (!heading.querySelector('.heading-anchor') && heading.id) {
                const a = document.createElement('a');
                a.href = `#${heading.id}`;
                a.className = 'heading-anchor';
                a.setAttribute('aria-label', 'Link to this section');
                heading.prepend(a);
            }
        });

        // Add copy buttons to code blocks
        const pres = container.querySelectorAll('pre');
        pres.forEach((pre) => {
            if (pre.querySelector('.copy-code-btn')) return;
            const code = pre.querySelector('code');
            if (!code) return;
            const btn = document.createElement('button');
            btn.className = 'copy-code-btn';
            btn.type = 'button';
            btn.textContent = 'Copy';
            btn.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(code.innerText);
                    const old = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => { btn.textContent = old; }, 1500);
                } catch (e) {
                    console.error('Copy failed', e);
                }
            });
            pre.appendChild(btn);
        });

        // No forced stacking of tables; render as standard tables per CSS
    }

    document.addEventListener('DOMContentLoaded', setupDocsLoading);
    document.addEventListener('astro:after-swap', setupDocsLoading);

    document.addEventListener('DOMContentLoaded', enhanceDocsContent);
    document.addEventListener('astro:after-swap', enhanceDocsContent);
</script>

