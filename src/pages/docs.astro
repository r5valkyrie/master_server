---
import Main from '../layouts/Main.astro';
import { marked } from 'marked';

const GITHUB_REPO = 'r5valkyrie/docs';
const GITHUB_BRANCH = 'main';

async function fetchFromGitHub(path: string) {
    const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/${GITHUB_BRANCH}/${path}`;
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error(`Failed to fetch ${path}`);
    }
    return response.text();
}

let sidebarConfig;
let content;
let htmlContent;
let error;

try {
    const sidebarConfigRaw = await fetchFromGitHub('docs/sidebar.json');
    sidebarConfig = JSON.parse(sidebarConfigRaw);
    
    const url = new URL(Astro.request.url);
    const pageSlug = url.searchParams.get('page') || sidebarConfig.startPage;

    // Validate pageSlug
    if (!/^[a-zA-Z0-9_-]+$/.test(pageSlug)) {
        throw new Error('Invalid page slug');
    }

    const contentRaw = await fetchFromGitHub(`docs/${pageSlug}.md`);
    htmlContent = marked(contentRaw);
} catch (e) {
    console.error(e);
    error = e;
}

const sidebar = sidebarConfig?.sidebar || [];
const currentPage = new URL(Astro.request.url).searchParams.get('page') || sidebarConfig?.startPage;
---

<Main title="Documentation">
	<div class="container page-container fade-in">
		<div class="docs-layout">
			<aside class="docs-sidebar">
				<div class="sidebar-inner">
					<h3>Documentation</h3>
                    {sidebar.length > 0 ? (
                        <nav>
                            {sidebar.map((section: any) => (
                                <div class="sidebar-section">
                                    <h4>{section.title}</h4>
                                    <ul>
                                        {section.pages.map((page: any) => (
                                            <li>
                                                <a 
                                                    href={`/docs?page=${encodeURIComponent(page.slug)}`} 
                                                    class={page.slug === currentPage ? 'active' : ''}
                                                >
                                                    {page.title}
                                                </a>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            ))}
                        </nav>
                    ) : (
                        <p class="error-text">Failed to load sidebar.</p>
                    )}
				</div>
			</aside>
			
			<div class="docs-content">
                {error ? (
                    <div class="alert-box error">
                        <h2>Error Loading Documentation</h2>
                        <p>Could not fetch documentation content. Please check your connection or try again later.</p>
                        <p class="error-details">{error.message}</p>
                    </div>
                ) : (
                    <div class="markdown-body" set:html={htmlContent} />
                )}
			</div>
		</div>
	</div>
</Main>

<style>
	.page-container {
		padding-top: 40px;
	}

	.docs-layout {
		display: grid;
		grid-template-columns: 280px 1fr;
		gap: 40px;
		align-items: start;
	}

	.docs-sidebar {
		position: sticky;
		top: 120px;
        max-height: calc(100vh - 140px);
        overflow-y: auto;
	}

	.sidebar-inner {
		background: var(--bg-card);
		border: 1px solid var(--border-light);
		border-radius: var(--radius-lg);
		padding: 24px;
		backdrop-filter: blur(10px);
	}

	.sidebar-inner h3 {
		font-size: 1.2rem;
		margin-bottom: 20px;
		padding-bottom: 16px;
		border-bottom: 1px solid var(--border-light);
	}

    .sidebar-section {
        margin-bottom: 20px;
    }

    .sidebar-section h4 {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-dim);
        margin-bottom: 10px;
    }

	.sidebar-inner ul {
		list-style: none;
        padding: 0;
	}

    .sidebar-inner li {
        margin-bottom: 4px;
    }

	.sidebar-inner a {
        display: block;
		padding: 8px 12px;
		border-radius: var(--radius-sm);
		color: var(--text-muted);
		font-size: 0.95rem;
		transition: all 0.2s;
	}

	.sidebar-inner a:hover {
		background: rgba(255, 255, 255, 0.05);
		color: var(--text-main);
	}

	.sidebar-inner a.active {
		background: rgba(99, 102, 241, 0.1);
		color: var(--primary);
		font-weight: 500;
	}

	.docs-content {
		background: var(--bg-card);
		border: 1px solid var(--border-light);
		border-radius: var(--radius-lg);
		padding: 60px;
		min-height: 600px;
	}

    /* Markdown Styles */
    .markdown-body :global(h1) { font-size: 2.5rem; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-light); }
    .markdown-body :global(h2) { font-size: 1.8rem; margin-top: 2rem; margin-bottom: 1rem; color: var(--text-main); }
    .markdown-body :global(h3) { font-size: 1.4rem; margin-top: 1.5rem; margin-bottom: 1rem; }
    .markdown-body :global(p) { line-height: 1.7; margin-bottom: 1.2rem; color: var(--text-muted); }
    .markdown-body :global(ul), .markdown-body :global(ol) { margin-bottom: 1.2rem; padding-left: 1.5rem; color: var(--text-muted); }
    .markdown-body :global(li) { margin-bottom: 0.5rem; }
    .markdown-body :global(a) { color: var(--primary); text-decoration: none; }
    .markdown-body :global(a:hover) { text-decoration: underline; }
    .markdown-body :global(code) { background: rgba(0,0,0,0.3); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
    .markdown-body :global(pre) { background: rgba(0,0,0,0.3); padding: 1.5rem; border-radius: var(--radius-md); overflow-x: auto; margin-bottom: 1.5rem; border: 1px solid var(--border-light); }
    .markdown-body :global(pre code) { background: none; padding: 0; font-size: 0.9em; color: #e5e7eb; }
    .markdown-body :global(blockquote) { border-left: 4px solid var(--primary); padding-left: 1rem; margin-left: 0; color: var(--text-dim); font-style: italic; }
    .markdown-body :global(img) { max-width: 100%; border-radius: var(--radius-md); margin: 1rem 0; }

	.alert-box {
		background: rgba(236, 72, 153, 0.1);
		border: 1px solid rgba(236, 72, 153, 0.2);
		padding: 24px;
		border-radius: var(--radius-md);
		color: #fce7f3;
	}

    .error-text { color: #ef4444; }
    .error-details { font-family: monospace; font-size: 0.85rem; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; margin-top: 10px; }

	@media (max-width: 768px) {
		.docs-layout {
			grid-template-columns: 1fr;
		}
		
		.docs-sidebar {
			position: static;
			margin-bottom: 30px;
            max-height: none;
		}

        .docs-content {
            padding: 30px;
        }
	}
</style>
