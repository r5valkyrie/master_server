---
import Main from '../layouts/Main.astro';

let eulaContent = '';
let lastModified = '';
let error = false;

try {
	const response = await fetch('https://playvalkyrie.org/api/eula');
	const data = await response.json();
	
	if (data.success && data.data) {
		eulaContent = data.data.contents;
		lastModified = data.data.modified ? new Date(data.data.modified).toLocaleDateString('en-US', { 
			year: 'numeric', 
			month: 'long', 
			day: 'numeric' 
		}) : 'Unknown';
	} else {
		error = true;
	}
} catch (e) {
	console.error('Failed to fetch EULA:', e);
	error = true;
}

// Convert newlines to paragraphs for display
const formatContent = (content: string) => {
	return content.split('\n\n').map(paragraph => {
		// Check if it's a heading (starts with number followed by period)
		if (/^\d+\./.test(paragraph.trim())) {
			const [heading, ...rest] = paragraph.split('\n');
			return `<h2>${heading}</h2>${rest.length > 0 ? '<p>' + rest.join('<br>') + '</p>' : ''}`;
		}
		// Check if it's a list
		if (paragraph.includes('\n-')) {
			const lines = paragraph.split('\n');
			const beforeList = lines.filter(l => !l.trim().startsWith('-'));
			const listItems = lines.filter(l => l.trim().startsWith('-'));
			return `${beforeList.length > 0 ? '<p>' + beforeList.join('<br>') + '</p>' : ''}<ul>${listItems.map(item => '<li>' + item.replace(/^-\s*/, '') + '</li>').join('')}</ul>`;
		}
		return `<p>${paragraph.replace(/\n/g, '<br>')}</p>`;
	}).join('');
};
---

<Main title="EULA">
	<div class="container page-container fade-in">
		<div class="eula-content">
			{error ? (
				<div class="error-message">
					<h1>Error Loading EULA</h1>
					<p>Failed to load the End User License Agreement. Please try again later.</p>
				</div>
			) : (
				<>
					<h1>End User License Agreement</h1>
					{lastModified && <p class="last-updated">Last Modified: {lastModified}</p>}
					<div class="eula-text" set:html={formatContent(eulaContent)} />
				</>
			)}
		</div>
	</div>
</Main>

<style>
	.page-container {
		padding-top: 40px;
		max-width: 900px;
	}

	.eula-content {
		background: var(--bg-card);
		border: 1px solid var(--border-light);
		border-radius: var(--radius-lg);
		padding: 60px;
		backdrop-filter: blur(10px);
	}

	h1 {
		font-size: 2.5rem;
		margin-bottom: 10px;
		text-align: center;
	}

	.last-updated {
		text-align: center;
		color: var(--text-muted);
		margin-bottom: 40px;
		font-style: italic;
		font-size: 0.9rem;
	}

	.eula-text :global(h2) {
		font-size: 1.5rem;
		margin-top: 30px;
		margin-bottom: 16px;
		color: var(--text-main);
	}

	.eula-text :global(p) {
		color: var(--text-muted);
		line-height: 1.7;
		margin-bottom: 16px;
	}

	.eula-text :global(ul) {
		list-style-type: disc;
		padding-left: 24px;
		color: var(--text-muted);
		margin-bottom: 16px;
	}

	.eula-text :global(li) {
		margin-bottom: 8px;
		line-height: 1.6;
	}

	.error-message {
		text-align: center;
		padding: 40px 0;
	}

	.error-message h1 {
		color: #ef4444;
		margin-bottom: 20px;
	}

	.error-message p {
		color: var(--text-muted);
	}

	@media (max-width: 768px) {
		.eula-content {
			padding: 30px;
		}

		h1 {
			font-size: 2rem;
		}
	}
</style>
