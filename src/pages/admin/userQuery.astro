---
import Dashboard from '../../layouts/Dashboard.astro';
---
<Dashboard>
  <!-- User Query Interface -->
  <div class="page-header">
    <h1 class="page-title">User Query</h1>
    <p class="page-description">Search and manage users by username or SteamID</p>
  </div>

  <!-- Advanced Search -->
  <div class="card mb-lg">
    <div class="card-header">
      <h3 class="card-title">Search Users</h3>
    </div>
    <div class="card-content">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-end">
        <div class="form-group lg:col-span-2">
          <label class="form-label" for="search-input">Search Query</label>
          <div class="search-container">
            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="text" id="search-input" class="search-input" placeholder="Steam ID (17 digits) or username..." />
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="search-type">Search Type</label>
          <select id="search-type" class="form-select">
            <option value="all">All Fields</option>
            <option value="username">Username Only</option>
            <option value="steam_id">Steam ID Only</option>
            <option value="exact">Exact Match</option>
          </select>
        </div>

        <div class="form-group">
          <button class="btn btn-primary w-full" id="search-btn">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            Search
          </button>
        </div>
      </div>

      <!-- Quick Filters -->
      <div class="flex flex-wrap gap-2 mt-4">
        <span class="text-sm text-gray-600">Quick filters:</span>
        <button class="btn btn-outline btn-sm filter-btn" data-filter="banned">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"></path>
          </svg>
          Banned Users
        </button>
        <button class="btn btn-outline btn-sm filter-btn" data-filter="recent">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Recently Active
        </button>
        <button class="btn btn-outline btn-sm filter-btn" data-filter="multiple-names">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
          Multiple Names
        </button>
      </div>
    </div>
  </div>

  <!-- Search Results -->
  <div id="search-results-section" class="hidden">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold">Search Results</h3>
      <div id="results-count" class="text-sm text-gray-500"></div>
    </div>
    
    <div id="results-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
      <!-- Results will be populated here -->
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="text-center py-12">
    <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
    <h3 class="text-lg font-medium text-gray-900 mb-2">Search for Users</h3>
    <p class="text-gray-500 mb-4">Enter a username or Steam ID to find user information</p>
    <div class="text-sm text-gray-400">
      <p>• Search by partial username matches</p>
      <p>• Look up users by exact Steam ID (17 digits)</p>
      <p>• View ban status and Steam profile details</p>
    </div>
  </div>

  <!-- User Details Modal -->
  <div id="user-details-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 48rem;">
      <div class="modal-header">
        <h3 class="modal-title">User Details</h3>
        <button class="modal-close" id="close-user-modal">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-content" id="user-details-content">
        <!-- User details will be populated here -->
      </div>
    </div>
  </div>

  <!-- Ban User Modal -->
  <div id="ban-user-modal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Ban User</h3>
        <button class="modal-close" id="close-ban-modal">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-content">
        <form id="ban-user-form">
          <div class="form-group">
            <label class="form-label" for="ban-reason">Ban Reason</label>
            <input type="text" id="ban-reason" class="form-input" placeholder="Enter reason for ban" required>
          </div>
          
          <div class="form-group">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="ban-permanent" class="form-checkbox" checked>
              <span class="form-label mb-0">Permanent Ban</span>
            </label>
          </div>
          
          <div class="form-group" id="ban-duration-group" style="display: none;">
            <label class="form-label" for="ban-duration">Ban Duration (days)</label>
            <input type="number" id="ban-duration" class="form-input" min="1" placeholder="Number of days">
          </div>
          
          <input type="hidden" id="ban-user-id">
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancel-ban">Cancel</button>
            <button type="submit" class="btn btn-danger">Ban User</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Steam Details Modal -->
  <div id="steam-details-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 48rem;">
      <div class="modal-header">
        <h3 class="modal-title">Steam Profile Details</h3>
        <button class="modal-close" id="close-steam-modal">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-content" id="steam-details-content">
        <!-- Steam details will be populated here -->
      </div>
    </div>
  </div>
</Dashboard>

<script>
// @ts-nocheck
document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const searchInput = document.getElementById('search-input');
  const searchBtn = document.getElementById('search-btn');
  const searchType = document.getElementById('search-type');
  const resultsSection = document.getElementById('search-results-section');
  const resultsContainer = document.getElementById('results-container');
  const resultsCount = document.getElementById('results-count');
  const emptyState = document.getElementById('empty-state');
  
  // Modals
  const userDetailsModal = document.getElementById('user-details-modal');
  const banUserModal = document.getElementById('ban-user-modal');
  const steamDetailsModal = document.getElementById('steam-details-modal');
  
  let currentSearchResults = [];
  let currentFilter = null;

  // Notification helper
  function notify(type, title, message) {
    window.showNotification?.(type, title, message);
  }

  // Modal management
  function openModal(modal) {
    if (modal) modal.classList.remove('hidden');
  }

  function closeModal(modal) {
    if (modal) modal.classList.add('hidden');
  }

  // Search functionality
  async function performSearch(query = null, filter = null) {
    const searchQuery = query || searchInput?.value?.trim() || '';
    const searchTypeValue = searchType?.value || 'all';
    
    if (!searchQuery && !filter) {
      showEmptyState();
      return;
    }

    try {
      showLoadingState();
      
      let url = '/api/admin/userQuery?query=' + encodeURIComponent(searchQuery);
      url += '&type=' + encodeURIComponent(searchTypeValue);
      if (filter) {
        url += '&filter=' + encodeURIComponent(filter);
      }
      
      console.log('Search URL:', url); // Debug log
      
      const response = await fetch(url);
      const data = await response.json();
      
      currentSearchResults = data.rows || [];
      currentFilter = filter;
      
      displayResults(currentSearchResults);
      
    } catch (error) {
      console.error('Search failed:', error);
      notify('error', 'Search Error', 'Failed to search users');
      showEmptyState();
    }
  }

  // Display search results
  function displayResults(users) {
    if (!users || users.length === 0) {
      showNoResults();
      return;
    }

    emptyState.classList.add('hidden');
    resultsSection.classList.remove('hidden');
    resultsCount.textContent = `${users.length} user${users.length === 1 ? '' : 's'} found`;

    resultsContainer.innerHTML = users.map(user => createUserCard(user)).join('');
    bindCardActions();
  }

  // Create user card HTML
  function createUserCard(user) {
    const statusColor = user.is_banned ? 'error' : 'success';
    const lastSeen = user.last_seen ? new Date(user.last_seen).toLocaleString() : 'Never';
    
    return `
      <div class="card hover:shadow-md transition-shadow">
        <div class="card-header">
          <div class="flex items-start justify-between w-full">
            <div class="flex-1">
              <h4 class="font-semibold text-lg mb-1">${user.name || '(Unknown)'}</h4>
              <p class="font-mono text-sm text-gray-500">${user.steam_id}</p>
            </div>
            <span class="badge ${user.is_banned ? 'badge-error' : 'badge-success'}">
              ${user.is_banned ? 'Banned' : 'Not Banned'}
            </span>
          </div>
        </div>
        
        <div class="card-content">
          <div class="grid grid-cols-2 gap-4 text-sm mb-4">
            <div>
              <span class="font-medium text-gray-700">Last Seen:</span>
              <p class="text-gray-600">${lastSeen}</p>
            </div>
            <div>
              <span class="font-medium text-gray-700">Aliases:</span>
              <p class="text-gray-600">${user.num_usernames || 0} names</p>
            </div>
          </div>
          
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-primary btn-sm" data-action="view-details" data-id="${user.steam_id}">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              View Details
            </button>
            
            ${user.is_banned ? `
              <button class="btn btn-success btn-sm" data-action="unban" data-id="${user.steam_id}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Unban
              </button>
            ` : `
              <button class="btn btn-danger btn-sm" data-action="ban" data-id="${user.steam_id}" data-name="${user.name || 'Unknown'}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"></path>
                </svg>
                Ban User
              </button>
            `}
            
            <button class="btn btn-outline btn-sm" data-action="show-names" data-id="${user.steam_id}">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
              </svg>
              Show Aliases
            </button>
            
            ${/^765611\d{11}$/.test(user.steam_id) ? `
              <button class="btn btn-outline btn-sm" data-action="steam-details" data-id="${user.steam_id}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V4a2 2 0 114 0v2m-4 0a2 2 0 104 0m-4 0v2m0 0h4"></path>
                </svg>
                Steam Details
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }

  // Show loading state
  function showLoadingState() {
    emptyState.classList.add('hidden');
    resultsSection.classList.remove('hidden');
    resultsCount.textContent = 'Searching...';
    resultsContainer.innerHTML = `
      <div class="col-span-full text-center py-8">
        <svg class="w-8 h-8 mx-auto mb-4 text-gray-300 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <p class="text-gray-500">Searching users...</p>
      </div>
    `;
  }

  // Show empty state
  function showEmptyState() {
    resultsSection.classList.add('hidden');
    emptyState.classList.remove('hidden');
  }

  // Show no results
  function showNoResults() {
    emptyState.classList.add('hidden');
    resultsSection.classList.remove('hidden');
    resultsCount.textContent = 'No users found';
    resultsContainer.innerHTML = `
      <div class="col-span-full text-center py-8 text-gray-500">
        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
        <p>No users found matching your search criteria</p>
        <p class="text-sm mt-2">Try adjusting your search terms or filters</p>
      </div>
    `;
  }

  // Bind card action handlers
  function bindCardActions() {
    // View details
    document.querySelectorAll('[data-action="view-details"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const userId = this.dataset.id;
        showUserDetails(userId);
      });
    });

    // Ban user
    document.querySelectorAll('[data-action="ban"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const userId = this.dataset.id;
        const userName = this.dataset.name;
        showBanModal(userId, userName);
      });
    });

    // Unban user
    document.querySelectorAll('[data-action="unban"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const userId = this.dataset.id;
        unbanUser(userId);
      });
    });

    // Show aliases
    document.querySelectorAll('[data-action="show-names"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const userId = this.dataset.id;
        showUserAliases(userId);
      });
    });

    // Steam details
    document.querySelectorAll('[data-action="steam-details"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const steamId = this.dataset.id;
        showSteamDetails(steamId);
      });
    });
  }

  // Show user details in modal
  async function showUserDetails(userId) {
    try {
      const [userResponse, aliasesResponse] = await Promise.all([
        fetch(`/api/admin/userQuery?query=${encodeURIComponent(userId)}`),
        fetch(`/api/admin/userQuery/usernames?uid=${encodeURIComponent(userId)}`)
      ]);

      const userData = await userResponse.json();
      const aliasesData = await aliasesResponse.json();
      
      const user = userData.rows?.[0];
      const aliases = aliasesData.usernames || [];

      if (!user) {
        notify('error', 'Error', 'User not found');
        return;
      }

      const content = document.getElementById('user-details-content');
      content.innerHTML = `
        <div class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-semibold text-lg mb-4">User Information</h4>
              <dl class="space-y-2">
                <div>
                  <dt class="text-sm font-medium text-gray-700">Current Name</dt>
                  <dd class="text-sm text-gray-900">${user.name || '(Unknown)'}</dd>
                </div>
                <div>
                  <dt class="text-sm font-medium text-gray-700">Steam ID</dt>
                  <dd class="text-sm font-mono text-gray-900">${user.steam_id}</dd>
                </div>
                <div>
                  <dt class="text-sm font-medium text-gray-700">Status</dt>
                  <dd class="text-sm">
                    <span class="badge ${user.is_banned ? 'badge-error' : 'badge-success'}">
                      ${user.is_banned ? 'Banned' : 'Not Banned'}
                    </span>
                  </dd>
                </div>
                <div>
                  <dt class="text-sm font-medium text-gray-700">Last Seen</dt>
                  <dd class="text-sm text-gray-900">${user.last_seen ? new Date(user.last_seen).toLocaleString() : 'Never'}</dd>
                </div>
              </dl>
            </div>
            
            <div>
              <h4 class="font-semibold text-lg mb-4">Username History (${aliases.length})</h4>
              ${aliases.length > 0 ? `
                <div class="max-h-48 overflow-y-auto">
                  <ul class="space-y-1">
                    ${aliases.map(alias => `
                      <li class="text-sm border-b border-gray-200 pb-1">
                        <div class="font-medium">${alias.name}</div>
                        <div class="text-gray-500 text-xs">${alias.last_seen ? new Date(alias.last_seen).toLocaleString() : 'Date unknown'}</div>
                      </li>
                    `).join('')}
                  </ul>
                </div>
              ` : '<p class="text-sm text-gray-500">No username history available</p>'}
            </div>
          </div>
          
          <div class="flex gap-2 pt-4 border-t border-gray-200">
            ${user.is_banned ? `
              <button class="btn btn-success" onclick="unbanUser('${user.steam_id}'); closeModal(userDetailsModal);">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Unban User
              </button>
            ` : `
              <button class="btn btn-danger" onclick="showBanModal('${user.steam_id}', '${user.name || 'Unknown'}'); closeModal(userDetailsModal);">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"></path>
                </svg>
                Ban User
              </button>
            `}
        </div>
        </div>
      `;

      openModal(userDetailsModal);
    } catch (error) {
      console.error('Failed to load user details:', error);
      notify('error', 'Error', 'Failed to load user details');
    }
  }

  // Show ban modal
  function showBanModal(userId, userName) {
    document.getElementById('ban-user-id').value = userId;
    document.querySelector('#ban-user-modal .modal-title').textContent = `Ban User: ${userName}`;
    openModal(banUserModal);
  }

  // Ban user
  async function banUser(userId, reason, permanent, duration) {
    try {
      const banData = {
        identifier: userId,
        banType: 1, // Origin ID
        reason: reason,
        permanent: permanent
      };

      if (!permanent && duration) {
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + parseInt(duration));
        banData.endDate = endDate.toISOString();
      }

      const response = await fetch('/api/admin/banlist', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(banData)
      });

      if (response.ok) {
        notify('success', 'Success', 'User banned successfully');
        closeModal(banUserModal);
        // Refresh search results
        if (currentSearchResults.length > 0) {
          performSearch();
        }
      } else {
        notify('error', 'Error', 'Failed to ban user');
      }
    } catch (error) {
      console.error('Ban error:', error);
      notify('error', 'Error', 'Failed to ban user');
    }
  }

  // Unban user
  async function unbanUser(userId) {
    try {
      const response = await fetch(`/api/admin/banlist?identifier=${encodeURIComponent(userId)}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        notify('success', 'Success', 'User unbanned successfully');
        // Refresh search results
        if (currentSearchResults.length > 0) {
          performSearch();
        }
      } else {
        notify('error', 'Error', 'Failed to unban user');
      }
    } catch (error) {
      console.error('Unban error:', error);
      notify('error', 'Error', 'Failed to unban user');
    }
  }

  // Show user aliases
  async function showUserAliases(userId) {
    showUserDetails(userId); // Reuse the details modal which includes aliases
  }

  // Show Steam details in modal
  async function showSteamDetails(steamId) {
    try {
      const content = document.getElementById('steam-details-content');
      content.innerHTML = `
        <div class="text-center py-8">
          <svg class="w-8 h-8 mx-auto mb-4 text-gray-300 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          <p class="text-gray-500">Loading Steam profile...</p>
        </div>
      `;

      openModal(steamDetailsModal);

      const response = await fetch(`/api/admin/steamProfile?steamid=${encodeURIComponent(steamId)}`);
      const data = await response.json();

      if (!data.success) {
        content.innerHTML = `
          <div class="text-center py-8">
            <svg class="w-12 h-12 mx-auto mb-4 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.502 0L4.232 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Unable to Load Steam Profile</h3>
            <p class="text-gray-500">${data.error}</p>
          </div>
        `;
        return;
      }

      const profile = data.profile;
      const banInfo = data.banInfo;

      // Format persona state
      const personaStates = {
        0: { text: 'Offline', color: 'text-gray-500' },
        1: { text: 'Online', color: 'text-green-500' },
        2: { text: 'Busy', color: 'text-red-500' },
        3: { text: 'Away', color: 'text-yellow-500' },
        4: { text: 'Snooze', color: 'text-blue-500' },
        5: { text: 'Looking to trade', color: 'text-purple-500' },
        6: { text: 'Looking to play', color: 'text-blue-500' }
      };

      const personaState = personaStates[profile.personastate] || { text: 'Unknown', color: 'text-gray-500' };

      // Format community visibility state
      const visibilityStates = {
        1: 'Private',
        2: 'Friends Only',  
        3: 'Public'
      };
      const visibilityState = visibilityStates[profile.communityvisibilitystate] || 'Unknown';

      content.innerHTML = `
        <style>
          .steam-profile-header {
            background: linear-gradient(135deg, var(--bg-2) 0%, var(--bg-3) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
          }
          .steam-avatar {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            position: relative;
          }
          .steam-status-dot {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid var(--bg-2);
          }
          .steam-online { background-color: #4ade80; }
          .steam-offline { background-color: #6b7280; }
          .steam-busy { background-color: #ef4444; }
          .steam-away { background-color: #f59e0b; }
          .steam-snooze { background-color: #3b82f6; }
          .steam-trade { background-color: #8b5cf6; }
          .steam-play { background-color: #06b6d4; }
          .steam-info-card {
            background: rgba(42, 48, 54, 0.6);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
          }
          .steam-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            color: var(--text-muted);
            font-weight: 600;
          }
          .steam-card-header svg {
            margin-right: 8px;
            width: 20px;
            height: 20px;
          }
          .steam-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
          }
          .steam-detail-row:last-child {
            border-bottom: none;
          }
          .steam-detail-label {
            color: var(--text-muted);
            font-size: 14px;
          }
          .steam-detail-value {
            color: white;
            font-weight: 500;
          }
          .steam-game-status {
            border-radius: 8px;
            padding: 16px;
            text-align: center;
          }
          .steam-game-active {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            border: 1px solid #10b981;
          }
          .steam-game-inactive {
            background: rgba(75, 85, 99, 0.3);
            border: 1px solid rgba(255,255,255,0.1);
          }
          .steam-ban-section {
            background: rgba(42, 48, 54, 0.8);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
          }
          .steam-ban-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
          }
          .steam-ban-clean {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
          }
          .steam-ban-active {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
          }
          .steam-ban-status {
            font-weight: 700;
            font-size: 16px;
            margin: 8px 0;
          }
          .steam-ban-clean .steam-ban-status {
            color: #10b981;
          }
          .steam-ban-active .steam-ban-status {
            color: #ef4444;
          }
          .steam-ban-details {
            font-size: 12px;
            background: rgba(239, 68, 68, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 8px;
            color: #fca5a5;
          }
          .steam-profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
          }
          .steam-ban-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
          }
          @media (max-width: 768px) {
            .steam-profile-grid {
              grid-template-columns: 1fr;
            }
            .steam-profile-header {
              padding: 16px;
            }
          }
        </style>
        
        <div>
          <!-- Profile Header -->
          <div class="steam-profile-header">
            <div style="display: flex; align-items: flex-start; gap: 24px;">
              <div style="position: relative;">
                <img src="${profile.avatarfull}" alt="${profile.personaname}" class="steam-avatar">
                <div class="steam-status-dot steam-${personaState.text.toLowerCase().replace(' ', '-')}"></div>
              </div>
              <div style="flex: 1;">
                <h3 style="font-size: 24px; font-weight: 700; color: white; margin: 0 0 8px 0;">${profile.personaname}</h3>
                ${profile.realname ? `<p style="font-size: 16px; color: var(--text-muted); margin: 0 0 12px 0;">${profile.realname}</p>` : ''}
                <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="width: 8px; height: 8px; border-radius: 50%;" class="steam-${personaState.text.toLowerCase().replace(' ', '-')}"></span>
                    <span style="font-size: 14px; color: white; font-weight: 500;">${personaState.text}</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <svg style="width: 16px; height: 16px; color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    <span style="font-size: 14px; color: var(--text-muted);">${visibilityState} Profile</span>
                  </div>
                </div>
                <div style="margin-top: 16px; display: flex; gap: 12px; align-items: center;">
                  <a href="${profile.profileurl}" target="_blank" class="btn-primary" style="padding: 8px 16px; text-decoration: none; border-radius: 6px; font-size: 14px; display: inline-flex; align-items: center; gap: 8px;">
                    <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-2M7 7l10 10M17 7l-10 10"></path>
                    </svg>
                    View Steam Profile
                  </a>
                  <span style="font-size: 12px; color: var(--text-muted); font-family: monospace;">${profile.steamid}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Information -->
          <div class="steam-profile-grid">
            <!-- Account Details -->
            <div class="steam-info-card">
              <div class="steam-card-header">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                Account Details
              </div>
              <div>
                ${profile.timecreated ? `
                  <div class="steam-detail-row">
                    <span class="steam-detail-label">Account Created</span>
                    <span class="steam-detail-value">${new Date(profile.timecreated).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                  </div>
                ` : ''}
                ${profile.lastlogoff ? `
                  <div class="steam-detail-row">
                    <span class="steam-detail-label">Last Online</span>
                    <span class="steam-detail-value">${new Date(profile.lastlogoff).toLocaleString()}</span>
                  </div>
                ` : ''}
                ${profile.loccountrycode ? `
                  <div class="steam-detail-row">
                    <span class="steam-detail-label">Location</span>
                    <span class="steam-detail-value">${profile.loccountrycode}${profile.locstatecode ? ', ' + profile.locstatecode : ''}</span>
                  </div>
                ` : ''}
                <div class="steam-detail-row">
                  <span class="steam-detail-label">Profile State</span>
                  <span class="steam-detail-value">${profile.profilestate === 1 ? 'Configured' : 'Not Configured'}</span>
                </div>
              </div>
            </div>

            <!-- Gaming Activity -->
            <div class="steam-info-card">
              <div class="steam-card-header">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-9-4h10a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2v-6a2 2 0 012-2z"></path>
                </svg>
                Gaming Activity
              </div>
              <div>
                ${profile.gameextrainfo ? `
                  <div class="steam-game-status steam-game-active">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                      <div style="width: 8px; height: 8px; background-color: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></div>
                      <div>
                        <div style="font-size: 14px; color: #10b981; font-weight: 600; margin-bottom: 4px;">Currently Playing</div>
                        <div style="font-size: 18px; font-weight: 700; color: white;">${profile.gameextrainfo}</div>
                        ${profile.gameserverip ? `<div style="font-size: 12px; color: #6ee7b7; font-family: monospace; margin-top: 4px;">Server: ${profile.gameserverip}</div>` : ''}
                      </div>
                    </div>
                  </div>
                ` : `
                  <div class="steam-game-status steam-game-inactive">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                      <div style="width: 8px; height: 8px; background-color: var(--text-muted); border-radius: 50%;"></div>
                      <div>
                        <div style="font-size: 14px; color: var(--text-muted); font-weight: 600; margin-bottom: 4px;">Status</div>
                        <div style="font-size: 18px; font-weight: 700; color: white;">Not currently playing</div>
                      </div>
                    </div>
                  </div>
                `}
              </div>
            </div>
          </div>

          ${banInfo ? `
            <!-- Steam Bans Information -->
            <div class="steam-ban-section">
              <div class="steam-card-header" style="margin-bottom: 20px;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.502 0L4.232 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                Steam Security Status
              </div>
              
              <div class="steam-ban-grid">
                <!-- VAC Ban Status -->
                <div class="steam-ban-card ${banInfo.vacBanned ? 'steam-ban-active' : 'steam-ban-clean'}">
                  <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                    ${banInfo.vacBanned ? `
                      <svg style="width: 20px; height: 20px; color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
                      </svg>
                    ` : `
                      <svg style="width: 20px; height: 20px; color: #10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                      </svg>
                    `}
                  </div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">VAC Status</div>
                  <div class="steam-ban-status">${banInfo.vacBanned ? 'BANNED' : 'Clean'}</div>
                  ${banInfo.vacBanned ? `
                    <div class="steam-ban-details">
                      ${banInfo.numberVACBans} ban(s) • ${banInfo.daysSinceLastBan} days ago
                    </div>
                  ` : ''}
                </div>

                <!-- Community Ban Status -->
                <div class="steam-ban-card ${banInfo.communityBanned ? 'steam-ban-active' : 'steam-ban-clean'}">
                  <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                    ${banInfo.communityBanned ? `
                      <svg style="width: 20px; height: 20px; color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
                      </svg>
                    ` : `
                      <svg style="width: 20px; height: 20px; color: #10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                      </svg>
                    `}
                  </div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Community</div>
                  <div class="steam-ban-status">${banInfo.communityBanned ? 'BANNED' : 'Clean'}</div>
                </div>

                <!-- Game Ban Status -->
                <div class="steam-ban-card ${banInfo.numberGameBans > 0 ? 'steam-ban-active' : 'steam-ban-clean'}">
                  <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                    ${banInfo.numberGameBans > 0 ? `
                      <svg style="width: 20px; height: 20px; color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
                      </svg>
                    ` : `
                      <svg style="width: 20px; height: 20px; color: #10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                      </svg>
                    `}
                  </div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Game Bans</div>
                  <div class="steam-ban-status">${banInfo.numberGameBans > 0 ? banInfo.numberGameBans + ' Ban(s)' : 'Clean'}</div>
                </div>
              </div>
              
              ${banInfo.economyBan && banInfo.economyBan !== 'none' ? `
                <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-top: 16px;">
                  <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <svg style="width: 20px; height: 20px; color: #f59e0b;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                    <div>
                      <div style="font-size: 14px; color: #f59e0b; font-weight: 600;">Trade Restriction</div>
                      <div style="font-size: 16px; font-weight: 700; color: #d97706; margin-top: 4px;">${banInfo.economyBan}</div>
                    </div>
                  </div>
                </div>
              ` : ''}
            </div>
          ` : ''}
        </div>
      `;

    } catch (error) {
      console.error('Failed to load Steam details:', error);
      const content = document.getElementById('steam-details-content');
      content.innerHTML = `
        <div class="text-center py-8">
          <svg class="w-12 h-12 mx-auto mb-4 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.502 0L4.232 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          <h3 class="text-lg font-medium text-gray-900 mb-2">Error Loading Steam Profile</h3>
          <p class="text-gray-500">Failed to load Steam profile data</p>
        </div>
      `;
    }
  }

  // Event listeners
  searchBtn?.addEventListener('click', () => performSearch());
  searchInput?.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      performSearch();
    }
  });

  // Quick filters
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const filter = this.dataset.filter;
      
      // Update button states
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      performSearch(null, filter);
    });
  });

  // Ban permanent checkbox toggle
  document.getElementById('ban-permanent')?.addEventListener('change', function() {
    const durationGroup = document.getElementById('ban-duration-group');
    if (durationGroup) {
      durationGroup.style.display = this.checked ? 'none' : 'block';
    }
  });

  // Ban form submission
  document.getElementById('ban-user-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const userId = document.getElementById('ban-user-id').value;
    const reason = document.getElementById('ban-reason').value;
    const permanent = document.getElementById('ban-permanent').checked;
    const duration = document.getElementById('ban-duration').value;

    banUser(userId, reason, permanent, duration);
  });

  // Modal close handlers
  document.querySelectorAll('.modal-close, #cancel-ban, #close-user-modal, #close-ban-modal, #close-steam-modal').forEach(btn => {
    btn.addEventListener('click', function() {
      closeModal(userDetailsModal);
      closeModal(banUserModal);
      closeModal(steamDetailsModal);
    });
  });

  // Close modals on overlay click
  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        closeModal(overlay);
      }
    });
  });

  // Make functions global for inline onclick handlers
  window.unbanUser = unbanUser;
  window.showBanModal = showBanModal;
  window.closeModal = closeModal;
  window.userDetailsModal = userDetailsModal;
  window.steamDetailsModal = steamDetailsModal;

  // Handle URL parameters for direct linking
  const params = new URLSearchParams(location.search);
  const preQuery = params.get('uid') || params.get('query') || '';
  if (preQuery) {
    searchInput.value = preQuery;
    performSearch();
  }
});
</script>



