---
import Dashboard from '../../layouts/Dashboard.astro';
---

<Dashboard>
  <div class="content-container">
    <div class="page-header">
      <h1>Settings</h1>
      <p>Manage Discord configuration and system settings</p>
    </div>

    <div class="settings-toolbar">
      <button class="btn btn-primary btn-lg" id="saveAllBtn">Save All Changes</button>
      <div id="statusMessage" class="status-message" style="display: none;"></div>
    </div>

    <div id="settingsContainer" class="settings-panels-container">
      <div class="loading">Loading settings...</div>
    </div>
  </div>

  <script>
    interface Setting {
      key: string;
      value: string;
      description: string;
      category: 'discord' | 'system';
      isPassword?: boolean;
    }

    interface SettingResponse {
      success: boolean;
      discord?: any[];
      system?: any[];
      error?: string;
    }

    const statusMessage = document.getElementById('statusMessage');
    const saveAllBtn = document.getElementById('saveAllBtn');
    const allSettings: Map<string, {key: string, category: string, originalValue: string, currentValue: string}> = new Map();

    function showMessage(message: string, isSuccess: boolean) {
      if (!statusMessage) return;
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${isSuccess ? 'success' : 'error'}`;
      statusMessage.style.display = 'block';

      setTimeout(() => {
        if (statusMessage) statusMessage.style.display = 'none';
      }, 5000);
    }

    async function saveAllSettings() {
      if (saveAllBtn) {
        saveAllBtn.textContent = 'Saving All...';
        saveAllBtn.classList.add('btn-loading');
        saveAllBtn.disabled = true;
      }

      try {
        const discordUpdates = [];
        const systemUpdates = [];

        allSettings.forEach((setting) => {
          if (setting.currentValue !== setting.originalValue) {
            if (setting.category === 'discord') {
              discordUpdates.push({ key: setting.key, value: setting.currentValue });
            } else {
              systemUpdates.push({ key: setting.key, value: setting.currentValue });
            }
          }
        });

        let hasErrors = false;

        if (discordUpdates.length > 0) {
          const response = await fetch('/api/admin/discordConfig', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ updates: discordUpdates })
          });
          const data = (await response.json()) as any;
          if (!data.success) hasErrors = true;
        }

        if (systemUpdates.length > 0) {
          const response = await fetch('/api/admin/systemSettings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ updates: systemUpdates })
          });
          const data = (await response.json()) as any;
          if (!data.success) hasErrors = true;
        }

        if (hasErrors) {
          showMessage('Some settings failed to save', false);
        } else if (discordUpdates.length + systemUpdates.length > 0) {
          showMessage('All settings saved successfully', true);
          // Update original values
          allSettings.forEach((setting) => {
            setting.originalValue = setting.currentValue;
          });
        } else {
          showMessage('No changes to save', true);
        }
      } catch (err) {
        console.error('Error saving all settings:', err);
        showMessage('Error saving settings', false);
      } finally {
        if (saveAllBtn) {
          saveAllBtn.textContent = 'Save All Changes';
          saveAllBtn.classList.remove('btn-loading');
          saveAllBtn.disabled = false;
        }
      }
    }

    async function loadSettings() {
      try {
        const discordResponse = await fetch('/api/admin/discordConfig');
        const systemResponse = await fetch('/api/admin/systemSettings');

        const discordData = (await discordResponse.json()) as any;
        const systemData = (await systemResponse.json()) as any;

        if (!discordData.success || !systemData.success) {
          showMessage('Failed to load settings', false);
          return;
        }

        const container = document.getElementById('settingsContainer');
        if (!container) return;

        // Map Discord settings
        const discordSettings: Setting[] = (discordData.config || []).map((item: any) => ({
          key: item.config_key,
          value: item.config_value || '',
          description: item.description || getDefaultDescription(item.config_key),
          category: 'discord',
          isPassword: item.config_key === 'DISCORD_BOT_TOKEN'
        }));

        // Map System settings
        const systemSettings: Setting[] = (systemData.settings || []).map((item: any) => ({
          key: item.setting_key,
          value: item.setting_value || '',
          description: getDefaultSystemDescription(item.setting_key),
          category: 'system',
          isPassword: item.setting_key === 'STEAM_WEB_API_KEY'
        }));

        const combinedSettings = [...discordSettings, ...systemSettings];

        if (combinedSettings.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>No settings available.</p></div>';
          return;
        }

        container.innerHTML = '';
        
        combinedSettings.forEach((setting: Setting) => {
          const panel = document.createElement('div');
          panel.className = `settings-panel settings-panel-${setting.category}`;
          const inputType = setting.isPassword ? 'password' : 'text';
          const categoryLabel = setting.category === 'discord' ? 'discord' : 'system';

          panel.innerHTML = `
            <div class="settings-panel-header">
              <div class="settings-panel-title">
                <span class="settings-section-label ${categoryLabel}">${setting.category}</span>
                <h3>${formatSettingKey(setting.key)}</h3>
              </div>
            </div>
            <div class="settings-panel-body">
              <p class="settings-panel-description">${setting.description}</p>
              <input
                type="${inputType}"
                class="settings-panel-input"
                value="${setting.value}"
                data-key="${setting.key}"
                data-category="${setting.category}"
                placeholder="Enter value"
              />
            </div>
          `;
          
          const input = panel.querySelector('.settings-panel-input') as HTMLInputElement;
          allSettings.set(setting.key, {
            key: setting.key,
            category: setting.category,
            originalValue: setting.value,
            currentValue: setting.value
          });
          
          input.addEventListener('change', () => {
            const settingData = allSettings.get(setting.key);
            if (settingData) {
              settingData.currentValue = input.value;
            }
          });

          container.appendChild(panel);
        });
      } catch (err) {
        console.error('Error loading settings:', err);
        showMessage('Error loading settings', false);
      }
    }

    function formatSettingKey(key: string): string {
      return key
        .replace(/^(DISCORD_|)/, '')
        .replace(/_CHANNEL_ID|_TOKEN|_IDS|_KEY|_INTERVAL|_PORT|_COMMUNITY|_APP_ID/g, '')
        .replace(/_/g, ' ')
        .split(' ')
        .map(word => word.charAt(0) + word.slice(1).toLowerCase())
        .join(' ');
    }

    function getDefaultDescription(key: string): string {
      const descriptions: { [key: string]: string } = {
        'DISCORD_BOT_TOKEN': 'Your Discord bot token (keep this secret)',
        'DISCORD_COMMAND_ALLOW_IDS': 'Comma-separated list of Discord user IDs allowed to run bot commands',
        'DISCORD_ADMIN_LOG_CHANNEL_ID': 'Channel for server startup and admin events',
        'DISCORD_SERVER_BROWSER_CHANNEL_ID': 'Channel showing active servers list (updates every 5 minutes)',
        'DISCORD_SERVER_COUNT_CHANNEL_ID': 'Channel name shows active server count',
        'DISCORD_PLAYER_COUNT_CHANNEL_ID': 'Channel name shows total online players',
        'DISCORD_MOD_UPDATES_CHANNEL_ID': 'Channel for Thunderstore mod release notifications'
      };
      return descriptions[key] || 'Configuration setting';
    }

    function getDefaultSystemDescription(key: string): string {
      const descriptions: { [key: string]: string } = {
        'STEAM_WEB_API_KEY': 'Your Steam Web API key (get from https://steamcommunity.com/dev/apikey)',
        'STEAM_APP_ID': 'Steam App ID (usually 1172470 for R5Valkyrie)',
        'THUNDERSTORE_COMMUNITY': 'Community key on Thunderstore for mod tracking',
        'THUNDERSTORE_CHECK_INTERVAL_MS': 'How often to check for mod updates (milliseconds, default: 300000)',
        'BAN_CLEANUP_INTERVAL_HOURS': 'How often to clean up expired bans (hours, default: 12)',
        'USER_CLEANUP_INACTIVE_HOURS': 'Inactivity threshold for user cleanup (hours, default: 24)',
        'DEFAULT_SERVER_PORT': 'Default port for server authentication fallback (default: 37015)'
      };
      return descriptions[key] || 'System setting';
    }

    // Attach save all listener
    saveAllBtn?.addEventListener('click', saveAllSettings);

    // Load settings on page load
    loadSettings();
  </script>
</Dashboard>
