---
import Dashboard from '../../layouts/Dashboard.astro';
---
<Dashboard>
  <!-- Checksums Management -->
  <div id="checksums-list">
    <!-- Page Header -->
    <div class="page-header">
      <h1>Checksums</h1>
      <p>Manage file integrity verification hashes</p>
    </div>

    <!-- Toolbar with Search and Actions -->
    <div class="checksums-toolbar">
      <div class="search-container">
        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input type="text" id="search-bar" class="search-input" placeholder="Search checksums..." />
      </div>
      <div class="checksums-actions">
        <button class="btn btn-primary" id="add-checksum-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Add Checksum
        </button>
        <button class="btn btn-success" id="push-checksums-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Apply Changes
        </button>
      </div>
    </div>

    <!-- Checksums Container -->
    <div id="checksums-container" class="checksums-grid">
      <div class="loading-state">
        <svg class="spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v4m0 12v4m9-9h-4M7 12H3m15.364 6.364l-2.828-2.828M6.464 6.464L3.636 3.636m12.728 0l-2.828 2.828M6.464 17.536L3.636 20.364"></path>
        </svg>
        <p>Loading checksums...</p>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="checksums-empty hidden">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p>No checksums found</p>
        <p class="text-sm mt-2">Click "Add Checksum" to create one</p>
      </div>

      <!-- Checksums will be rendered here -->
      <div id="checksums-items" class="checksums-items"></div>
    </div>
  </div>

  <!-- Add Checksum Modal -->
  <div id="checksums-add" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add New Checksum</h3>
        <button class="modal-close" id="close-add-modal">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-content">
        <form id="checksums-add-form">
          <div class="form-group">
            <label class="form-label" for="checksumInput">Checksum</label>
            <input type="text" id="checksumInput" class="form-input" required placeholder="Enter checksum hash">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="sdkversionInput">SDK Version</label>
            <select id="sdkversionInput" class="form-select">
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="descriptionInput">Description</label>
            <textarea id="descriptionInput" class="form-textarea" rows="3" placeholder="Optional description or notes"></textarea>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancel-add-btn">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Checksum</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Update Checksum Modal -->
  <div id="checksums-update" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Update Checksum</h3>
        <button class="modal-close" id="close-update-modal">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-content">
        <form id="checksums-update-form">
          <div class="form-group">
            <label class="form-label" for="checksum2Input">Checksum</label>
            <input type="text" id="checksum2Input" class="form-input" readonly>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="sdkversion2Input">SDK Version</label>
            <select id="sdkversion2Input" class="form-select">
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="description2Input">Description</label>
            <textarea id="description2Input" class="form-textarea" rows="3" placeholder="Optional description or notes"></textarea>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancel-update-btn">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Checksum</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</Dashboard>

<script>
// @ts-nocheck
document.addEventListener('DOMContentLoaded', function () {
  let lastOpenedVersion = '';
  let firstVersion = '';

  // Modal elements
  const addModal = document.getElementById('checksums-add');
  const updateModal = document.getElementById('checksums-update');
  const addBtn = document.getElementById('add-checksum-btn');
  const pushBtn = document.getElementById('push-checksums-btn');
  const searchBar = document.getElementById('search-bar');

  // Notification helper
  function notify(type, title, message) {
    window.showNotification?.(type, title, message);
  }

  // Modal management
  function openModal(modal) {
    if (modal) modal.classList.remove('hidden');
  }

  function closeModal(modal) {
    if (modal) modal.classList.add('hidden');
  }

  // Add checksum button
  if (addBtn) {
    addBtn.addEventListener('click', async function() {
      const sel = document.getElementById('sdkversionInput');
      if (sel && sel.tagName === 'SELECT') {
        // Always populate options when modal opens
        await populateVersionOptions(sel);
        const pre = lastOpenedVersion || firstVersion || '';
        if (pre) sel.value = pre;
      }
      openModal(addModal);
    });
  }

  // Push to master button
  if (pushBtn) {
    pushBtn.addEventListener('click', async function() {
      pushBtn.disabled = true;
      const originalText = pushBtn.textContent;
      pushBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Syncing...';
      
      try {
        const res = await fetch('/api/admin/checksumsPush', { method: 'POST' });
        if (res.ok) {
          notify('success', 'Success', 'Checksums synced successfully');
        } else {
          notify('error', 'Error', 'Failed to sync checksums');
        }
      } catch (e) {
        notify('error', 'Error', 'Failed to sync checksums');
      } finally {
        pushBtn.disabled = false;
        pushBtn.innerHTML = originalText;
      }
    });
  }

  // Populate version select options
  async function populateVersionOptions(selectElement) {
    try {
      console.log('Populating version options for:', selectElement.id); // Debug logging
      
      // Fetch versions from API
      const response = await fetch('/api/admin/versions');
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('Received versions data:', data); // Debug logging
      
      const versions = data.versions || [];
      
      selectElement.innerHTML = '';
      
      if (versions.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.text = 'No versions available';
        option.disabled = true;
        option.selected = true;
        selectElement.appendChild(option);
        console.warn('No versions available from API');
        return;
      }
      
      // Add a default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.text = 'Select a version';
      defaultOption.disabled = true;
      defaultOption.selected = true;
      selectElement.appendChild(defaultOption);
      
      // Add version options
      versions.forEach(version => {
        const option = document.createElement('option');
        option.value = version.name;
        option.text = version.name;
        selectElement.appendChild(option);
      });
      
      console.log(`Successfully populated ${versions.length} versions`); // Debug logging
      
    } catch (error) {
      console.error('Failed to load versions:', error);
      selectElement.innerHTML = '<option value="" disabled selected>Failed to load versions</option>';
      notify('error', 'Error', 'Failed to load versions for dropdown');
    }
  }

  // Action handlers for checksum items
  function bindActionHandlers() {
    // Bind add buttons (opens modal with pre-filled version)
    document.querySelectorAll('.btn-add-version').forEach(btn => {
      btn.addEventListener('click', function() {
        const version = this.getAttribute('data-version');
        lastOpenedVersion = version;
        
        const sel = document.getElementById('sdkversionInput');
        if (sel && sel.tagName === 'SELECT') {
          populateVersionOptions(sel).then(() => {
            sel.value = version;
          });
        }
        openModal(addModal);
      });
    });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Fetch and display checksums
  async function fetchChecksums() {
    try {
      const response = await fetch('/api/admin/checksums');
      const payload = await response.json();
      const groupedChecksums = payload.checksums || {};
      const itemsContainer = document.getElementById('checksums-items');
      const loadingState = document.getElementById('checksums-list').querySelector('.loading-state');
      const emptyState = document.getElementById('empty-state');
      
      if (!itemsContainer) return;

      const searchQuery = searchBar?.value?.toLowerCase() || '';
      const keys = Object.keys(groupedChecksums);
      firstVersion = keys.length > 0 ? keys[0] : '';

      loadingState?.classList.add('hidden');

      // Filter versions with matching checksums
      let hasResults = false;
      const versionCards = [];

      for (const sdkVersion in groupedChecksums) {
        const checksums = groupedChecksums[sdkVersion];
        const filteredChecksums = checksums.filter(checksum => {
          if (!searchQuery) return true;
          const rowText = (checksum.checksum + ' ' + (checksum.description || '')).toLowerCase();
          return rowText.includes(searchQuery);
        });

        if (filteredChecksums.length > 0) {
          hasResults = true;
          versionCards.push({ version: sdkVersion, checksums: filteredChecksums });
        }
      }

      if (!hasResults) {
        itemsContainer.innerHTML = '';
        emptyState?.classList.remove('hidden');
      } else {
        emptyState?.classList.add('hidden');
        
        itemsContainer.innerHTML = versionCards.map(({ version, checksums }) => `
          <div class="checksum-card">
            <div class="checksum-card-header">
              <h3 class="checksum-version-title">${escapeHtml(version)}</h3>
              <span class="checksum-count-badge">${checksums.length}</span>
            </div>
            <div class="checksum-card-body">
              <div class="checksums-list">
                ${checksums.map(checksum => `
                  <div class="checksum-item">
                    <div class="checksum-details">
                      <code class="checksum-hash">${escapeHtml(checksum.checksum)}</code>
                      ${checksum.description ? `
                        <div class="checksum-description">${escapeHtml(checksum.description)}</div>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="checksum-card-footer">
              <button class="btn btn-sm btn-outline btn-add-version" data-version="${escapeHtml(version)}" title="Add checksum to this version">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add
              </button>
            </div>
          </div>
        `).join('');

        bindActionHandlers();
      }
    } catch (error) {
      console.error('Failed to fetch checksums:', error);
      notify('error', 'Error', 'Failed to load checksums');
    }
  }



  // Search functionality
  if (searchBar) {
    let searchTimer;
    searchBar.addEventListener('input', function() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(fetchChecksums, 300);
    });
  }

  // Form submissions
  const addForm = document.getElementById('checksums-add-form');
  if (addForm) {
    addForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const checksumInput = document.getElementById('checksumInput');
      const sdkversionInput = document.getElementById('sdkversionInput');
      const descriptionInput = document.getElementById('descriptionInput');
      
      // Frontend validation
      const checksum = checksumInput.value.trim();
      const sdkversion = sdkversionInput.value;
      const description = descriptionInput.value.trim();
      
      if (!checksum) {
        notify('error', 'Validation Error', 'Please enter a checksum hash');
        checksumInput.focus();
        return;
      }
      
      if (!sdkversion || sdkversion === '') {
        notify('error', 'Validation Error', 'Please select an SDK version');
        sdkversionInput.focus();
        return;
      }

      const formData = {
        checksum: checksum,
        sdkversion: sdkversion,
        description: description || null
      };

      try {
        console.log('Submitting checksum data:', formData); // Debug logging
        
        const res = await fetch('/api/admin/checksums', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const data = await res.json();

        if (res.ok) {
          notify('success', 'Success', data.message || 'Checksum added successfully');
          closeModal(addModal);
          addForm.reset();
          fetchChecksums();
        } else {
          // Use the detailed error message from the API
          const errorMessage = data.details || data.error || 'Failed to add checksum';
          notify('error', 'Error', errorMessage);
          console.error('API Error:', data);
        }
      } catch (error) {
        console.error('Add error:', error);
        notify('error', 'Error', 'Network error: Failed to add checksum');
      }
    });
  }

  const updateForm = document.getElementById('checksums-update-form');
  if (updateForm) {
    updateForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        checksum: document.getElementById('checksum2Input').value,
        sdkversion: document.getElementById('sdkversion2Input').value,
        description: document.getElementById('description2Input').value.trim()
      };

      try {
        const res = await fetch('/api/admin/checksums', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (res.ok) {
          notify('success', 'Success', 'Checksum updated');
          closeModal(updateModal);
          fetchChecksums();
        } else {
          notify('error', 'Error', 'Failed to update checksum');
        }
      } catch (error) {
        console.error('Update error:', error);
        notify('error', 'Error', 'Failed to update checksum');
      }
    });
  }

  // Modal close handlers
  document.querySelectorAll('.modal-close, #cancel-add-btn, #cancel-update-btn, #close-add-modal, #close-update-modal').forEach(btn => {
    btn.addEventListener('click', function() {
      closeModal(addModal);
      closeModal(updateModal);
    });
  });

  // Close modals on overlay click
  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        closeModal(overlay);
      }
    });
  });

  // Initial load
  fetchChecksums();
});
</script>
