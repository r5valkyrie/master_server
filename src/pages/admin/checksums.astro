---
import Dashboard from '../../layouts/Dashboard.astro';
---
<Dashboard>
  <!-- Checksums Management -->
  <div id="checksums-list">
    <!-- Header Actions -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
      <div class="search-container">
        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input type="text" id="search-bar" class="search-input" placeholder="Search checksums..." />
      </div>
      <div class="flex gap-2">
        <button class="btn btn-primary" id="add-checksum-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Add Checksum
        </button>
        <button class="btn btn-success" id="push-checksums-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Sync to Master
        </button>
      </div>
    </div>

    <!-- Checksums Container -->
    <div id="checksums-container">
      <div class="text-center py-8 text-gray-500">
        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p>Loading checksums...</p>
      </div>
    </div>
  </div>

  <!-- Add Checksum Modal -->
  <div id="checksums-add" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add New Checksum</h3>
        <button class="modal-close" id="close-add-modal">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-content">
        <form id="checksums-add-form">
          <div class="form-group">
            <label class="form-label" for="checksumInput">Checksum</label>
            <input type="text" id="checksumInput" class="form-input" required placeholder="Enter checksum hash">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="sdkversionInput">SDK Version</label>
            <select id="sdkversionInput" class="form-select">
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="descriptionInput">Description</label>
            <textarea id="descriptionInput" class="form-textarea" rows="3" placeholder="Optional description or notes"></textarea>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancel-add-btn">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Checksum</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Update Checksum Modal -->
  <div id="checksums-update" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Update Checksum</h3>
        <button class="modal-close" id="close-update-modal">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-content">
        <form id="checksums-update-form">
          <div class="form-group">
            <label class="form-label" for="checksum2Input">Checksum</label>
            <input type="text" id="checksum2Input" class="form-input" readonly>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="sdkversion2Input">SDK Version</label>
            <select id="sdkversion2Input" class="form-select">
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="description2Input">Description</label>
            <textarea id="description2Input" class="form-textarea" rows="3" placeholder="Optional description or notes"></textarea>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancel-update-btn">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Checksum</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</Dashboard>

<script>
// @ts-nocheck
document.addEventListener('DOMContentLoaded', function () {
  let lastOpenedVersion = '';
  let firstVersion = '';

  // Modal elements
  const addModal = document.getElementById('checksums-add');
  const updateModal = document.getElementById('checksums-update');
  const addBtn = document.getElementById('add-checksum-btn');
  const pushBtn = document.getElementById('push-checksums-btn');
  const searchBar = document.getElementById('search-bar');

  // Notification helper
  function notify(type, title, message) {
    window.showNotification?.(type, title, message);
  }

  // Modal management
  function openModal(modal) {
    if (modal) modal.classList.remove('hidden');
  }

  function closeModal(modal) {
    if (modal) modal.classList.add('hidden');
  }

  // Add checksum button
  if (addBtn) {
    addBtn.addEventListener('click', async function() {
      const sel = document.getElementById('sdkversionInput');
      if (sel && sel.tagName === 'SELECT') {
        // Always populate options when modal opens
        await populateVersionOptions(sel);
        const pre = lastOpenedVersion || firstVersion || '';
        if (pre) sel.value = pre;
      }
      openModal(addModal);
    });
  }

  // Push to master button
  if (pushBtn) {
    pushBtn.addEventListener('click', async function() {
      pushBtn.disabled = true;
      const originalText = pushBtn.textContent;
      pushBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Syncing...';
      
      try {
        const res = await fetch('/api/admin/checksumsPush', { method: 'POST' });
        if (res.ok) {
          notify('success', 'Success', 'Checksums synced successfully');
        } else {
          notify('error', 'Error', 'Failed to sync checksums');
        }
      } catch (e) {
        notify('error', 'Error', 'Failed to sync checksums');
      } finally {
        pushBtn.disabled = false;
        pushBtn.innerHTML = originalText;
      }
    });
  }

  // Populate version select options
  async function populateVersionOptions(selectElement) {
    try {
      console.log('Populating version options for:', selectElement.id); // Debug logging
      
      // Fetch versions from API
      const response = await fetch('/api/admin/versions');
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('Received versions data:', data); // Debug logging
      
      const versions = data.versions || [];
      
      selectElement.innerHTML = '';
      
      if (versions.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.text = 'No versions available';
        option.disabled = true;
        option.selected = true;
        selectElement.appendChild(option);
        console.warn('No versions available from API');
        return;
      }
      
      // Add a default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.text = 'Select a version';
      defaultOption.disabled = true;
      defaultOption.selected = true;
      selectElement.appendChild(defaultOption);
      
      // Add version options
      versions.forEach(version => {
        const option = document.createElement('option');
        option.value = version.name;
        option.text = version.name;
        selectElement.appendChild(option);
      });
      
      console.log(`Successfully populated ${versions.length} versions`); // Debug logging
      
    } catch (error) {
      console.error('Failed to load versions:', error);
      selectElement.innerHTML = '<option value="" disabled selected>Failed to load versions</option>';
      notify('error', 'Error', 'Failed to load versions for dropdown');
    }
  }

  // Action handlers for checksum items
  function bindActionHandlers() {
    // Bind edit buttons
    document.querySelectorAll('.btn-edit').forEach(btn => {
      btn.addEventListener('click', function() {
        const checksum = this.getAttribute('data-checksum');
        const description = this.getAttribute('data-description');
        const version = this.getAttribute('data-version');
        
        // Populate edit form
        document.getElementById('checksum2Input').value = checksum;
        document.getElementById('description2Input').value = description;
        
        const versionSelect = document.getElementById('sdkversion2Input');
        populateVersionOptions(versionSelect).then(() => {
          versionSelect.value = version;
        });

        openModal(updateModal);
      });
    });

    // Bind delete buttons
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', async function() {
        const checksum = this.getAttribute('data-checksum');
        
        if (!confirm(`Are you sure you want to delete checksum ${checksum}?`)) return;

        try {
          const res = await fetch(`/api/admin/checksums?checksum=${encodeURIComponent(checksum)}`, {
            method: 'DELETE' 
          });
          
          if (res.ok) {
            notify('success', 'Success', 'Checksum deleted');
            fetchChecksums();
          } else {
            notify('error', 'Error', 'Failed to delete checksum');
          }
        } catch (error) {
          console.error('Delete error:', error);
          notify('error', 'Error', 'Failed to delete checksum');
        }
      });
    });
  }

  // Fetch and display checksums
  async function fetchChecksums() {
    try {
      const response = await fetch('/api/admin/checksums');
      const payload = await response.json();
      const groupedChecksums = payload.checksums || {};
      const container = document.getElementById('checksums-container');
      
      if (!container) return;

      const searchQuery = searchBar?.value?.toLowerCase() || '';
      const keys = Object.keys(groupedChecksums);
      firstVersion = keys.length > 0 ? keys[0] : '';

      if (keys.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p>No checksums found</p>
          </div>
        `;
        return;
      }

      let hasResults = false;
      let html = '';

      for (const sdkVersion in groupedChecksums) {
        const checksums = groupedChecksums[sdkVersion];
        const filteredChecksums = checksums.filter(checksum => {
          if (!searchQuery) return true;
          const rowText = (checksum.checksum + ' ' + (checksum.description || '')).toLowerCase();
          return rowText.includes(searchQuery);
        });

        if (filteredChecksums.length === 0) continue;
        hasResults = true;

        html += `
          <div class="version-card" data-version="${sdkVersion}">
            <div class="version-card-header">
              <div class="version-info">
                <div class="version-meta">
                  <span class="checksum-count">${filteredChecksums.length} checksum${filteredChecksums.length !== 1 ? 's' : ''}</span>
                </div>
              </div>
              <div class="version-badge">${sdkVersion}</div>
            </div>
            <div class="version-card-content">
              <div class="checksums-list">
                ${filteredChecksums.map(checksum => `
                  <div class="checksum-item">
                    <div class="checksum-details">
                      <div class="checksum-hash">
                        <span class="hash-label">Hash:</span>
                        <code class="hash-value">${checksum.checksum}</code>
                      </div>
                      ${checksum.description ? `
                        <div class="checksum-description">
                          <span class="desc-label">Description:</span>
                          <span class="desc-value">${checksum.description}</span>
                        </div>
                      ` : ''}
                    </div>
                    <div class="checksum-actions">
                      <button class="action-btn edit-btn btn-edit" data-checksum="${checksum.checksum}" data-description="${checksum.description || ''}" data-version="${sdkVersion}" title="Edit checksum">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                      </button>
                      <button class="action-btn delete-btn btn-delete" data-checksum="${checksum.checksum}" title="Delete checksum">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      }

      if (!hasResults) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p>No checksums match your search</p>
          </div>
        `;
      } else {
              container.innerHTML = `<div class="checksums-grid">${html}</div>`;
        bindActionHandlers();
      }
    } catch (error) {
      console.error('Failed to fetch checksums:', error);
      notify('error', 'Error', 'Failed to load checksums');
    }
  }



  // Search functionality
  if (searchBar) {
    let searchTimer;
    searchBar.addEventListener('input', function() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(fetchChecksums, 300);
    });
  }

  // Form submissions
  const addForm = document.getElementById('checksums-add-form');
  if (addForm) {
    addForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const checksumInput = document.getElementById('checksumInput');
      const sdkversionInput = document.getElementById('sdkversionInput');
      const descriptionInput = document.getElementById('descriptionInput');
      
      // Frontend validation
      const checksum = checksumInput.value.trim();
      const sdkversion = sdkversionInput.value;
      const description = descriptionInput.value.trim();
      
      if (!checksum) {
        notify('error', 'Validation Error', 'Please enter a checksum hash');
        checksumInput.focus();
        return;
      }
      
      if (!sdkversion || sdkversion === '') {
        notify('error', 'Validation Error', 'Please select an SDK version');
        sdkversionInput.focus();
        return;
      }

      const formData = {
        checksum: checksum,
        sdkversion: sdkversion,
        description: description || null
      };

      try {
        console.log('Submitting checksum data:', formData); // Debug logging
        
        const res = await fetch('/api/admin/checksums', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const data = await res.json();

        if (res.ok) {
          notify('success', 'Success', data.message || 'Checksum added successfully');
          closeModal(addModal);
          addForm.reset();
          fetchChecksums();
        } else {
          // Use the detailed error message from the API
          const errorMessage = data.details || data.error || 'Failed to add checksum';
          notify('error', 'Error', errorMessage);
          console.error('API Error:', data);
        }
      } catch (error) {
        console.error('Add error:', error);
        notify('error', 'Error', 'Network error: Failed to add checksum');
      }
    });
  }

  const updateForm = document.getElementById('checksums-update-form');
  if (updateForm) {
    updateForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        checksum: document.getElementById('checksum2Input').value,
        sdkversion: document.getElementById('sdkversion2Input').value,
        description: document.getElementById('description2Input').value.trim()
      };

      try {
        const res = await fetch('/api/admin/checksums', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (res.ok) {
          notify('success', 'Success', 'Checksum updated');
          closeModal(updateModal);
          fetchChecksums();
        } else {
          notify('error', 'Error', 'Failed to update checksum');
        }
      } catch (error) {
        console.error('Update error:', error);
        notify('error', 'Error', 'Failed to update checksum');
      }
    });
  }

  // Modal close handlers
  document.querySelectorAll('.modal-close, #cancel-add-btn, #cancel-update-btn, #close-add-modal, #close-update-modal').forEach(btn => {
    btn.addEventListener('click', function() {
      closeModal(addModal);
      closeModal(updateModal);
    });
  });

  // Close modals on overlay click
  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        closeModal(overlay);
      }
    });
  });

  // Initial load
  fetchChecksums();
});
</script>
