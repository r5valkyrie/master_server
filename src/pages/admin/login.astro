---
import AuthLayout from '../../layouts/Auth.astro';
---
<AuthLayout>
  <form id="login-form" class="auth-form">
    <!-- Login Panel -->
    <div id="login-panel" class="auth-panel">
      <div class="form-group">
        <label for="username" class="form-label">Username</label>
        <div class="form-input-wrap">
          <svg class="form-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>
          </svg>
          <input id="username" name="username" type="text" class="form-input" autocomplete="username" placeholder="Enter username" required />
        </div>
      </div>

      <div class="form-group">
        <label for="password" class="form-label">Password</label>
        <div class="form-input-wrap">
          <svg class="form-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/>
          </svg>
          <input id="password" name="password" type="password" class="form-input" autocomplete="current-password" placeholder="Enter password" required />
          <button type="button" id="toggle-password" class="password-toggle" tabindex="-1">
            <svg id="eye-icon" class="toggle-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </button>
        </div>
      </div>

      <button type="submit" id="login-btn" class="btn btn-primary btn-full">
        <span class="btn-text">Sign In</span>
        <svg class="btn-spinner hidden" viewBox="0 0 24 24" width="18" height="18">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25"/>
          <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
        </svg>
      </button>
    </div>

    <!-- Error Alert -->
    <div id="login-error" class="alert alert-error hidden" style="margin-top: 1rem;">
      <svg class="alert-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
      </svg>
      <div class="alert-content">
        <div class="alert-title">Authentication Failed</div>
        <div class="alert-message"></div>
      </div>
    </div>

    <!-- Password Change Panel -->
    <div id="change-panel" class="auth-panel hidden">
      <div class="change-header">
        <svg class="change-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.5rem; height: 1.5rem; color: #a78bfa;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/>
        </svg>
        <div>
          <h3 class="change-title">Set New Password</h3>
          <p class="change-subtitle">Create a secure password to continue.</p>
        </div>
      </div>

      <div class="form-group">
        <label for="newpass" class="form-label">New Password</label>
        <input id="newpass" name="newpass" type="password" class="form-input" autocomplete="new-password" placeholder="Min 8 characters" />
      </div>

      <div class="form-group">
        <label for="newpass2" class="form-label">Confirm Password</label>
        <input id="newpass2" name="newpass2" type="password" class="form-input" autocomplete="new-password" placeholder="Re-enter password" />
      </div>

      <button type="button" id="change-pass-btn" class="btn btn-primary btn-full">
        <span class="btn-text">Update & Sign In</span>
        <svg class="btn-spinner hidden" viewBox="0 0 24 24" width="18" height="18">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25"/>
          <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
        </svg>
      </button>
    </div>
  </form>

  <style>
    .auth-form { display: flex; flex-direction: column; }
    .auth-panel { transition: opacity 0.3s ease; }
    .auth-panel.hidden { display: none; }

    .form-input-wrap {
      position: relative;
      display: flex;
      align-items: center;
    }
    .form-input-icon {
      position: absolute;
      left: 0.875rem;
      width: 1.125rem;
      height: 1.125rem;
      color: #5a5a6e;
      pointer-events: none;
      z-index: 1;
    }
    .form-input-wrap .form-input {
      padding-left: 2.75rem;
    }
    .password-toggle {
      position: absolute;
      right: 0.75rem;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.25rem;
      color: #5a5a6e;
      transition: color 0.2s;
      z-index: 1;
    }
    .password-toggle:hover { color: #a78bfa; }
    .toggle-icon { width: 1.125rem; height: 1.125rem; }

    .change-header {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      background: rgba(139, 92, 246, 0.06);
      border: 1px solid rgba(139, 92, 246, 0.12);
      border-radius: 0.75rem;
    }
    .change-title {
      color: #e8e8f0;
      font-size: 0.9rem;
      font-weight: 600;
      margin: 0;
    }
    .change-subtitle {
      color: #7a7a90;
      font-size: 0.8rem;
      margin: 0.25rem 0 0;
    }

    .btn-spinner { animation: spin 0.6s linear infinite; }
    .btn-spinner.hidden { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('login-form') as HTMLFormElement;
  const errorEl = document.getElementById('login-error');
  const loginPanel = document.getElementById('login-panel');
  const changePanel = document.getElementById('change-panel');
  const loginBtn = document.getElementById('login-btn') as HTMLButtonElement;
  const changeBtn = document.getElementById('change-pass-btn') as HTMLButtonElement;
  const togglePassword = document.getElementById('toggle-password');
  const passwordInput = document.getElementById('password') as HTMLInputElement;

  if (!form) return;

  // Toggle password visibility
  togglePassword?.addEventListener('click', () => {
    const show = passwordInput.type === 'password';
    passwordInput.type = show ? 'text' : 'password';
    const icon = document.getElementById('eye-icon');
    if (icon) {
      icon.innerHTML = show
        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"/>'
        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>';
    }
  });

  function showError(msg: string, title = 'Authentication Failed') {
    if (!errorEl) return;
    const t = errorEl.querySelector('.alert-title');
    const m = errorEl.querySelector('.alert-message');
    if (t) t.textContent = title;
    if (m) m.textContent = msg;
    errorEl.classList.remove('hidden');
  }

  function hideError() { errorEl?.classList.add('hidden'); }

  function setLoading(btn: HTMLButtonElement | null, loading: boolean) {
    if (!btn) return;
    btn.disabled = loading;
    const text = btn.querySelector('.btn-text') as HTMLElement;
    const spinner = btn.querySelector('.btn-spinner') as HTMLElement;
    if (text) text.style.opacity = loading ? '0.5' : '1';
    if (spinner) spinner.classList.toggle('hidden', !loading);
  }

  function switchPanel(hide: HTMLElement | null, show: HTMLElement | null) {
    if (hide) { hide.style.opacity = '0'; setTimeout(() => hide.classList.add('hidden'), 250); }
    if (show) { setTimeout(() => { show.classList.remove('hidden'); show.style.opacity = '1'; }, hide ? 250 : 0); }
  }

  // Login submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();

    const username = (document.getElementById('username') as HTMLInputElement)?.value.trim();
    const password = passwordInput?.value;

    if (!username || !password) { showError('Please enter both username and password.'); return; }

    setLoading(loginBtn, true);
    try {
      const res = await fetch('/api/admin/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json().catch(() => { throw new Error('Invalid server response'); });

      if (!res.ok || !data.success) throw new Error(data.error || 'Login failed');

      if (data.mustChangePassword) {
        switchPanel(loginPanel, changePanel);
        setupPasswordChange(username);
      } else {
        window.location.href = '/admin/dashboard';
      }
    } catch (err: any) {
      showError(err.message || 'Network error');
    } finally {
      setLoading(loginBtn, false);
    }
  });

  function setupPasswordChange(username: string) {
    const fresh = changeBtn?.cloneNode(true) as HTMLButtonElement;
    changeBtn?.parentNode?.replaceChild(fresh, changeBtn);

    fresh?.addEventListener('click', async () => {
      hideError();
      const np = (document.getElementById('newpass') as HTMLInputElement)?.value;
      const np2 = (document.getElementById('newpass2') as HTMLInputElement)?.value;

      if (!np?.trim()) { showError('Please enter a new password.', 'Validation Error'); return; }
      if (np.length < 8) { showError('Password must be at least 8 characters.', 'Validation Error'); return; }
      if (np !== np2) { showError('Passwords do not match.', 'Validation Error'); return; }

      setLoading(fresh, true);
      try {
        const res = await fetch('/api/admin/auth/changePassword', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, newPassword: np })
        });
        const data = await res.json().catch(() => { throw new Error('Invalid server response'); });
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed to change password');
        window.location.href = '/admin/dashboard';
      } catch (err: any) {
        showError(err.message || 'Network error');
      } finally {
        setLoading(fresh, false);
      }
    });
  }
});
  </script>
</AuthLayout>
