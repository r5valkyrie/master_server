---
import DashboardLayout from '../../layouts/Dashboard.astro';
---

<DashboardLayout>
  <div class="content-container">
    <div class="page-header">
      <h1>System Settings</h1>
      <p>Manage system configuration settings</p>
    </div>

    <div class="config-section">
      <div class="section-header">
        <h2>Configuration</h2>
        <p>Update system settings that control application behavior</p>
      </div>

      <form id="systemSettingsForm" class="config-form">
        <div id="settingsFields" class="config-fields">
          <!-- Fields will be loaded dynamically -->
          <div class="loading">Loading configuration...</div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Save Settings</button>
        </div>

        <div id="statusMessage" class="status-message" style="display: none;"></div>
      </form>
    </div>

    <div class="info-section">
      <h3>Available Settings</h3>
      <ul>
        <li><strong>Steam Web Api Key:</strong> Your Steam Web API key for profile lookups</li>
        <li><strong>Steam App ID:</strong> The Steam App ID (usually 1172470 for R5Valkyrie)</li>
        <li><strong>Thunderstore Community:</strong> Community key on Thunderstore for mod tracking</li>
        <li><strong>Thunderstore Check Interval (ms):</strong> How often to check for mod updates (in milliseconds)</li>
        <li><strong>Ban Cleanup Interval (hours):</strong> How often to clean up expired bans</li>
        <li><strong>User Cleanup Inactive (hours):</strong> Inactivity threshold for user cleanup</li>
        <li><strong>Default Server Port:</strong> Default port for server authentication fallback</li>
      </ul>
    </div>
  </div>

  <style>
    .content-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .page-header {
      margin-bottom: 2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 1rem;
    }

    .page-header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2rem;
      color: #fff;
    }

    .page-header p {
      color: rgba(255, 255, 255, 0.7);
      margin: 0;
    }

    .config-section {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .section-header {
      margin-bottom: 2rem;
    }

    .section-header h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.5rem;
      color: #fff;
    }

    .section-header p {
      color: rgba(255, 255, 255, 0.6);
      margin: 0;
    }

    .config-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .config-fields {
      display: grid;
      gap: 1.5rem;
    }

    .config-field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .config-field label {
      font-weight: 600;
      color: #fff;
      font-size: 0.95rem;
    }

    .config-field .field-description {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.6);
    }

    .config-field input {
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      color: #fff;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      width: 100%;
      box-sizing: border-box;
    }

    .config-field input:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .config-field input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.15);
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .config-field input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: #3b82f6;
      color: #fff;
    }

    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .status-message {
      padding: 1rem;
      border-radius: 4px;
      font-weight: 500;
      text-align: center;
    }

    .status-message.success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
    }

    .status-message.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .loading {
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
      padding: 2rem;
    }

    .info-section {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 2rem;
    }

    .info-section h3 {
      margin: 0 0 1rem 0;
      color: #fff;
      font-size: 1.1rem;
    }

    .info-section h3:not(:first-child) {
      margin-top: 2rem;
    }

    .info-section ol,
    .info-section ul {
      margin: 0;
      padding-left: 1.5rem;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.6;
    }

    .info-section li {
      margin-bottom: 0.75rem;
    }

    .info-section strong {
      color: #fff;
    }
  </style>

  <script>
    interface SystemSetting {
      setting_key: string;
      setting_value: string;
      description: string;
    }

    async function loadSettings() {
      try {
        const response = await fetch('/api/admin/systemSettings');
        const data = await response.json() as any;

        if (!data.success) {
          showError('Failed to load configuration');
          return;
        }

        const fieldsContainer = document.getElementById('settingsFields');
        if (!fieldsContainer) return;
        fieldsContainer.innerHTML = '';

        // Define field order and hints
        const fieldOrder = [
          { key: 'STEAM_WEB_API_KEY', hint: 'Get this from https://steamcommunity.com/dev/apikey' },
          { key: 'STEAM_APP_ID', hint: 'Default: 1172470 for R5Valkyrie' },
          { key: 'THUNDERSTORE_COMMUNITY', hint: 'Default: r5valkyrie' },
          { key: 'THUNDERSTORE_CHECK_INTERVAL_MS', hint: 'Milliseconds, default: 300000 (5 minutes)' },
          { key: 'BAN_CLEANUP_INTERVAL_HOURS', hint: 'Hours, default: 12' },
          { key: 'USER_CLEANUP_INACTIVE_HOURS', hint: 'Hours, default: 24' },
          { key: 'DEFAULT_SERVER_PORT', hint: 'Default: 37015' }
        ];

        // Create a map of settings
        const settingMap = new Map(data.settings.map((item: SystemSetting) => [item.setting_key, item]));

        // Render in specified order
        fieldOrder.forEach((field) => {
          const item = settingMap.get(field.key) as SystemSetting | undefined;
          if (!item) return;

          const fieldDiv = document.createElement('div');
          fieldDiv.className = 'config-field';
          const label = field.key
            .split('_')
            .map((word: string) => word.charAt(0) + word.slice(1).toLowerCase())
            .join(' ');

          fieldDiv.innerHTML = `
            <label for="${item.setting_key}">${label}</label>
            <input
              type="text"
              id="${item.setting_key}"
              name="${item.setting_key}"
              placeholder="Enter value"
              value="${item.setting_value || ''}"
              data-key="${item.setting_key}"
            />
            <div class="field-description">${field.hint}</div>
          `;
          fieldsContainer.appendChild(fieldDiv);
        });
      } catch (err) {
        console.error('Error loading settings:', err);
        showError('Error loading configuration');
      }
    }

    function showMessage(message: string, isSuccess: boolean) {
      const statusDiv = document.getElementById('statusMessage');
      if (!statusDiv) return;
      statusDiv.textContent = message;
      statusDiv.className = `status-message ${isSuccess ? 'success' : 'error'}`;
      statusDiv.style.display = 'block';

      setTimeout(() => {
        if (statusDiv) statusDiv.style.display = 'none';
      }, 5000);
    }

    function showError(message: string) {
      showMessage(message, false);
    }

    const form = document.getElementById('systemSettingsForm');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const inputs = document.querySelectorAll('.config-field input');
        const updates = Array.from(inputs).map(input => ({
          key: (input as HTMLInputElement).dataset.key,
          value: (input as HTMLInputElement).value
        }));

        try {
          const response = await fetch('/api/admin/systemSettings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ updates })
          });

          const data = await response.json() as any;

          if (data.success) {
            showMessage(`Successfully saved ${data.updated} setting(s)`, true);
          } else {
            showError(data.error || 'Failed to save configuration');
          }
        } catch (err) {
          console.error('Error saving settings:', err);
          showError('Error saving configuration');
        }
      });
    }

    // Load settings on page load
    loadSettings();
  </script>
</DashboardLayout>
