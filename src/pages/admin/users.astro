---
import Dashboard from '../../layouts/Dashboard.astro';
---
<Dashboard>
  <div id="users-list">
    <!-- Page Header -->
    <div class="page-header">
      <h1>Users</h1>
      <p>View and manage registered users</p>
    </div>

    <!-- Search and Table Card -->
    <div class="card">
      <div class="card-header">
        <div class="search-container" style="max-width:28rem;">
          <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input type="text" id="search-bar" class="search-input" placeholder="Search by Steam ID or username..." />
        </div>
      </div>

      <div class="card-content">
        <!-- Quick Filters -->
        <div class="filter-group" style="margin-bottom:1rem;">
          <span class="text-sm text-gray-500" style="margin-right:0.5rem;">Quick filters:</span>
          <button class="filter-btn filter-btn active" data-filter="">All Users</button>
          <button class="filter-btn" data-filter="banned">Banned</button>
          <button class="filter-btn" data-filter="recent">Recently Active</button>
          <button class="filter-btn" data-filter="valid-steam">Valid Steam IDs</button>
          <button class="filter-btn" data-filter="multiple-names">Multiple Names</button>
        </div>

        <div class="table-container">
          <table class="table" id="users-table">
            <thead>
              <tr>
                <th>Steam ID</th>
                <th>Status</th>
                <th>Last Seen</th>
                <th>Name</th>
                <th>Ban Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <!-- Rows will be inserted here by script -->
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <div class="pagination-info">
            <span id="page-info">Loading...</span>
          </div>
          <div class="pagination-controls">
            <button class="btn btn-outline btn-sm" id="prev-page">Previous</button>
            <span id="page-number" class="text-sm text-gray-500">Page 1</span>
            <button class="btn btn-outline btn-sm" id="next-page">Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</Dashboard>

<!-- Ban User Modal -->
<div id="ban-modal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Ban User</h3>
      <button class="modal-close" onclick="closeBanModal()">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="form-label">User</label>
        <div style="color:var(--gray-800);">
          <strong id="ban-modal-user-name"></strong>
          <span style="color:var(--gray-500);">(<span id="ban-modal-steam-id"></span>)</span>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="ban-reason">Ban Reason *</label>
        <textarea id="ban-reason" class="form-textarea" rows="3" placeholder="Enter reason for ban..." required></textarea>
      </div>

      <div class="form-group">
        <label class="form-label" for="ban-days">Duration (days)</label>
        <input type="number" id="ban-days" class="form-input" placeholder="Leave empty for permanent ban" min="1">
        <div class="form-help">Leave empty for permanent ban</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeBanModal()">Cancel</button>
      <button class="btn btn-danger" onclick="submitBan()">Ban User</button>
    </div>
  </div>
</div>

<script>
// @ts-nocheck
document.addEventListener('DOMContentLoaded', function() {
  let currentPage = 1;
  const pageSize = 50;
  let total = 0;
  let query = '';
  let currentFilter = '';

  const searchBar = document.getElementById('search-bar');

  function updatePager() {
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    const pageInfo = document.getElementById('page-info');
    const pageNumber = document.getElementById('page-number');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');

    if (pageInfo) {
      const start = (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, total);
      pageInfo.textContent = `Showing ${start}-${end} of ${total} users`;
    }

    if (pageNumber) pageNumber.textContent = `Page ${currentPage} of ${totalPages}`;
    if (prevBtn) prevBtn.disabled = currentPage <= 1;
    if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
  }

  if (searchBar) {
    let debounceTimer;
    searchBar.addEventListener('input', function() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(function() {
        query = searchBar.value.trim();
        currentPage = 1;
        fetchUsers();
      }, 300);
    });
  }

  // XSS-safe user row creation
  function createUserRow(user) {
    const row = document.createElement('tr');

    const lastSeen = user.last_seen ? new Date(user.last_seen).toLocaleString() : 'Never';
    const isBanned = user.is_banned === 1 || user.is_banned === true;
    const steamId = user.steam_id || '';
    const isValidSteamId = /^765611\d{11}$/.test(steamId);

    // Steam ID cell
    const steamIdCell = document.createElement('td');
    steamIdCell.style.fontFamily = 'monospace';
    steamIdCell.style.fontSize = '0.85rem';
    const steamIdSpan = document.createElement('span');
    steamIdSpan.style.color = isValidSteamId ? '#34d399' : '#f87171';
    steamIdSpan.style.fontWeight = '500';
    steamIdSpan.textContent = steamId || 'N/A';
    steamIdCell.appendChild(steamIdSpan);

    // Status cell
    const statusCell = document.createElement('td');
    const statusBadge = document.createElement('span');
    statusBadge.className = isValidSteamId ? 'badge badge-success' : 'badge badge-error';
    statusBadge.textContent = isValidSteamId ? 'Valid' : (steamId ? 'Invalid' : 'Unknown');
    statusCell.appendChild(statusBadge);

    // Last seen cell
    const lastSeenCell = document.createElement('td');
    lastSeenCell.style.fontSize = '0.85rem';
    lastSeenCell.textContent = lastSeen;

    // Name cell (SAFE - using textContent)
    const nameCell = document.createElement('td');
    nameCell.style.fontSize = '0.85rem';
    if (user.name) {
      nameCell.textContent = user.name;
    } else {
      const emElement = document.createElement('em');
      emElement.style.color = '#a0a0b8';
      emElement.textContent = 'Unknown';
      nameCell.appendChild(emElement);
    }

    // Ban status cell
    const banStatusCell = document.createElement('td');
    const banBadge = document.createElement('span');
    if (isBanned) {
      banBadge.className = 'badge badge-error';
      banBadge.textContent = 'Banned';
      if (user.ban_reason) {
        const banDate = user.ban_date ? new Date(user.ban_date).toLocaleDateString() : 'Unknown';
        banBadge.title = `Banned on ${banDate}: ${user.ban_reason}`;
      }
    } else {
      banBadge.className = 'badge badge-success';
      banBadge.textContent = 'Active';
    }
    banStatusCell.appendChild(banBadge);

    // Actions cell
    const actionsCell = document.createElement('td');
    const actionsDiv = document.createElement('div');
    actionsDiv.style.display = 'flex';
    actionsDiv.style.gap = '0.375rem';

    // Details button
    const detailsBtn = document.createElement('button');
    detailsBtn.className = 'btn btn-primary btn-sm';
    detailsBtn.innerHTML = `
      <svg style="width:1rem;height:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 616 0z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
      </svg>
      Details
    `;
    detailsBtn.onclick = () => window.location.href = `/admin/userQuery?uid=${encodeURIComponent(user.steam_id || '')}`;
    actionsDiv.appendChild(detailsBtn);

    // Ban/Unban button
    if (isBanned) {
      const unbanBtn = document.createElement('button');
      unbanBtn.className = 'btn btn-ghost btn-sm';
      unbanBtn.style.color = '#34d399';
      unbanBtn.innerHTML = `
        <svg style="width:1rem;height:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>
        </svg>
        Unban
      `;
      unbanBtn.onclick = () => window.unbanUser(user.steam_id, user.name || 'Unknown');
      actionsDiv.appendChild(unbanBtn);
    } else {
      const banBtn = document.createElement('button');
      banBtn.className = 'btn btn-danger btn-sm';
      banBtn.innerHTML = `
        <svg style="width:1rem;height:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"></path>
        </svg>
        Ban
      `;
      banBtn.onclick = () => window.banUser(user.steam_id, user.name || 'Unknown');
      actionsDiv.appendChild(banBtn);
    }

    // Steam profile button
    if (isValidSteamId) {
      const steamBtn = document.createElement('button');
      steamBtn.className = 'btn btn-ghost btn-sm';
      steamBtn.title = 'View Steam Profile';
      steamBtn.innerHTML = `
        <svg style="width:1rem;height:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
        </svg>
      `;
      steamBtn.onclick = () => window.open(`https://steamcommunity.com/profiles/${encodeURIComponent(steamId)}`, '_blank');
      actionsDiv.appendChild(steamBtn);
    }

    actionsCell.appendChild(actionsDiv);

    row.appendChild(steamIdCell);
    row.appendChild(statusCell);
    row.appendChild(lastSeenCell);
    row.appendChild(nameCell);
    row.appendChild(banStatusCell);
    row.appendChild(actionsCell);

    return row;
  }

  // Fetch and display users
  async function fetchUsers() {
    try {
      let url = `/api/admin/users?page=${currentPage}&limit=${pageSize}`;
      if (query) url += '&q=' + encodeURIComponent(query);
      if (currentFilter) url += '&filter=' + encodeURIComponent(currentFilter);

      const response = await fetch(url);
      const payload = await response.json();
      const users = payload.data || [];
      total = payload.total || 0;

      const tableBody = document.getElementById('users-table-body');
      if (!tableBody) return;

      tableBody.innerHTML = '';

      if (users.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;

        const div = document.createElement('div');
        div.className = 'empty-state';
        div.innerHTML = `
          <svg style="width:3rem;height:3rem;margin-bottom:1rem;color:#a0a0b8;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"></path>
          </svg>
        `;

        const p1 = document.createElement('p');
        p1.style.color = '#e8e8f0';
        p1.textContent = 'No users found';
        div.appendChild(p1);

        const p2 = document.createElement('p');
        p2.style.color = '#a0a0b8';
        p2.style.fontSize = '0.85rem';
        p2.textContent = query ? 'Try adjusting your search criteria' : 'Try searching for a Steam ID (17 digits) or username';
        div.appendChild(p2);

        cell.appendChild(div);
        row.appendChild(cell);
        tableBody.appendChild(row);
      } else {
        users.forEach(user => {
          tableBody.appendChild(createUserRow(user));
        });
      }

      updatePager();
    } catch (error) {
      window.showNotification?.('error', 'Error', 'Failed to load users');
    }
  }

  // Pagination handlers
  document.getElementById('prev-page')?.addEventListener('click', function() {
    if (currentPage > 1) {
      currentPage--;
      fetchUsers();
    }
  });

  document.getElementById('next-page')?.addEventListener('click', function() {
    currentPage++;
    fetchUsers();
  });

  // Quick filter handlers
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const filter = this.dataset.filter;

      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.remove('active');
      });
      this.classList.add('active');

      currentFilter = filter;
      currentPage = 1;
      fetchUsers();
    });
  });

  // Set default filter state
  document.querySelector('.filter-btn[data-filter=""]')?.classList.add('active');

  // Modal functions
  function openModal(modal) {
    if (modal) modal.classList.remove('hidden');
  }

  function closeModal(modal) {
    if (modal) modal.classList.add('hidden');
  }

  // Ban/Unban functions
  window.banUser = function(steamId, userName) {
    document.getElementById('ban-modal-user-name').textContent = userName;
    document.getElementById('ban-modal-steam-id').textContent = steamId;
    document.getElementById('ban-reason').value = '';
    document.getElementById('ban-days').value = '';
    openModal(document.getElementById('ban-modal'));
  };

  window.unbanUser = async function(steamId, userName) {
    if (!confirm(`Are you sure you want to unban ${userName} (${steamId})?`)) return;

    try {
      const response = await fetch('/api/admin/ban', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'remove', id: steamId }),
      });

      const result = await response.json();

      if (result.success) {
        window.showNotification?.('success', 'Success', `${userName} has been unbanned`);
        fetchUsers();
      } else {
        window.showNotification?.('error', 'Error', result.message || 'Failed to unban user');
      }
    } catch (error) {
      window.showNotification?.('error', 'Error', 'An error occurred while unbanning the user');
    }
  };

  window.submitBan = async function() {
    const steamId = document.getElementById('ban-modal-steam-id').textContent;
    const userName = document.getElementById('ban-modal-user-name').textContent;
    const reason = document.getElementById('ban-reason').value.trim();
    const days = document.getElementById('ban-days').value.trim();

    if (!reason) {
      window.showNotification?.('error', 'Validation', 'Please enter a ban reason');
      return;
    }

    try {
      const banData = {
        type: 'add',
        id: steamId,
        reason: reason,
        banType: 1
      };

      if (days && !isNaN(parseInt(days))) {
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + parseInt(days));
        banData.expiryDate = expiryDate.toISOString();
      }

      const response = await fetch('/api/admin/ban', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(banData),
      });

      const result = await response.json();

      if (result.success) {
        window.showNotification?.('success', 'Success', `${userName} has been banned`);
        window.closeBanModal();
        fetchUsers();
      } else {
        window.showNotification?.('error', 'Error', result.message || result.error || 'Failed to ban user');
      }
    } catch (error) {
      window.showNotification?.('error', 'Error', 'An error occurred while banning the user');
    }
  };

  window.closeBanModal = function() {
    closeModal(document.getElementById('ban-modal'));
  };

  // Close modal on escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      const modal = document.getElementById('ban-modal');
      if (modal && !modal.classList.contains('hidden')) {
        window.closeBanModal();
      }
    }
  });

  // Close modal when clicking overlay
  document.addEventListener('click', function(event) {
    const modal = document.getElementById('ban-modal');
    if (event.target === modal) {
      window.closeBanModal();
    }
  });

  // Initial load
  fetchUsers();
});
</script>
