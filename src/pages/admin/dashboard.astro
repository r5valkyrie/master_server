---
import DashboardLayout from '../../layouts/Dashboard.astro';
import ModernChart from '../../components/admin/ModernChart.astro';
---
<DashboardLayout>
  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon primary">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"></path></svg>
      </div>
      <div class="stat-content">
        <div class="stat-label">Total Users</div>
        <div class="stat-value" id="totalUsers">—</div>
        <div class="stat-change" id="totalUsersChange">Loading…</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon primary">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"></path></svg>
      </div>
      <div class="stat-content">
        <div class="stat-label">Online Players</div>
        <div class="stat-value" id="currentPlayers">—</div>
        <div class="stat-change" id="currentPlayersChange">Loading…</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon success">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 019.374 21c-2.331 0-4.512-.645-6.374-1.766z"></path></svg>
      </div>
      <div class="stat-content">
        <div class="stat-label">New Users Today</div>
        <div class="stat-value" id="newUsersToday">—</div>
        <div class="stat-change" id="newUsersTodayChange">Loading…</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon warning">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path></svg>
      </div>
      <div class="stat-content">
        <div class="stat-label">Servers</div>
        <div class="stat-value" id="totalServers">—</div>
        <div class="stat-change" id="totalServersChange">Loading…</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon success">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      </div>
      <div class="stat-content">
        <div class="stat-label">Uptime</div>
        <div class="stat-value" id="serverUptime">—</div>
        <div class="stat-change" id="serverUptimeChange">Loading…</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" id="systemHealthIcon">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      </div>
      <div class="stat-content">
        <div class="stat-label">System Health</div>
        <div class="stat-value" id="systemHealthStatus">—</div>
        <div class="stat-change" id="systemHealthChange">Loading…</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon warning">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
      </div>
      <div class="stat-content">
        <div class="stat-label">Bans Today</div>
        <div class="stat-value" id="bansToday">—</div>
        <div class="stat-change" id="bansTodayChange">Loading…</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon error">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
      </div>
      <div class="stat-content">
        <div class="stat-label">Active Bans</div>
        <div class="stat-value" id="activeBans">—</div>
        <div class="stat-change" id="activeBansChange">Loading…</div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2">
    <ModernChart chartId="players" title="Players Over Time" timeRange={14} />
    <ModernChart chartId="bans" title="Bans Over Time" timeRange={120} />
  </div>

  <!-- Recent Activity -->
  <div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
      <h3 class="card-title">Recent Activity</h3>
      <button class="btn btn-ghost btn-sm" id="refreshActivity">
        <svg style="width:1rem;height:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182"></path>
        </svg>
        Refresh
      </button>
    </div>
    <div class="card-content">
      <div id="activity-feed" class="activity-feed">
        <div class="empty-state">
          <svg style="width:2.5rem;height:2.5rem;margin-bottom:0.75rem;opacity:0.3;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p>Loading recent activity…</p>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>

<script>
// @ts-nocheck
(function(){
  async function loadDashboardStats() {
    try {
      document.getElementById('totalUsers').textContent = '0';
      document.getElementById('totalUsersChange').textContent = 'No data';

      const bansRes = await fetch('/api/admin/banlist?page=1&limit=1');
      const bansData = await bansRes.json();
      document.getElementById('activeBans').textContent = bansData.total || '0';
      document.getElementById('activeBansChange').textContent = `${bansData.total || 0} active`;

      document.getElementById('currentPlayers').textContent = '0';
      document.getElementById('currentPlayersChange').textContent = 'No data';
      document.getElementById('totalServers').textContent = '0';
      document.getElementById('totalServersChange').textContent = 'No data';

      await loadServerUptime();
      await loadPlayerStats();
      await loadBanStats();
      await loadUserGrowthStats();
      await loadSystemHealth();
    } catch (e) { console.error('Dashboard stats error:', e); }
  }

  async function loadServerUptime() {
    try {
      const r = await fetch('/api/admin/uptime');
      const d = await r.json();
      if (d.success && d.uptime) {
        document.getElementById('serverUptime').textContent = d.uptime.formatted;
        document.getElementById('serverUptimeChange').textContent = 'Since restart';
      } else {
        document.getElementById('serverUptime').textContent = 'Error';
        document.getElementById('serverUptimeChange').textContent = 'Failed';
      }
    } catch { document.getElementById('serverUptime').textContent = 'Error'; }
  }

  async function loadPlayerStats() {
    try {
      const r = await fetch('/api/admin/playerStats');
      const d = await r.json();
      if (d.success && d.playerStats) {
        const s = d.playerStats;
        document.getElementById('currentPlayers').textContent = s.current.onlinePlayers.toString();
        document.getElementById('currentPlayersChange').textContent = `Peak: ${s.peaks.todayPeak}`;
        document.getElementById('totalServers').textContent = s.current.activeServers.toString();
        document.getElementById('totalServersChange').textContent = `${s.current.capacityUsed}% capacity`;
      }
    } catch {}
  }

  async function loadBanStats() {
    try {
      const r = await fetch('/api/admin/banStats');
      const d = await r.json();
      if (d.success && d.banStats) {
        const s = d.banStats;
        document.getElementById('bansToday').textContent = s.current.last24Hours.toString();
        document.getElementById('bansTodayChange').textContent = `${s.trends.averageDaily}/day avg`;
        document.getElementById('activeBans').textContent = s.current.last30Days.toString();
        document.getElementById('activeBansChange').textContent = `${s.current.last7Days} this week`;
      }
    } catch {}
  }

  async function loadUserGrowthStats() {
    try {
      const r = await fetch('/api/admin/userGrowth');
      const d = await r.json();
      if (d.success && d.userGrowth) {
        const s = d.userGrowth;
        document.getElementById('newUsersToday').textContent = s.current.newToday.toString();
        document.getElementById('newUsersTodayChange').textContent = `${s.current.newThisWeek} this week`;
        document.getElementById('totalUsers').textContent = s.current.totalUsers.toString();
        document.getElementById('totalUsersChange').textContent = `${s.current.activeUsers} active (7d)`;
      }
    } catch {}
  }

  async function loadSystemHealth() {
    try {
      const r = await fetch('/api/admin/systemHealth');
      const d = await r.json();
      if (d.success && d.systemHealth) {
        const h = d.systemHealth;
        const ok = h.overallStatus === 'healthy';
        document.getElementById('systemHealthStatus').textContent = ok ? 'Healthy' : 'Degraded';
        document.getElementById('systemHealthChange').textContent = `DB: ${h.database.status}, Redis: ${h.redis.status}`;
        const icon = document.getElementById('systemHealthIcon');
        if (icon) icon.className = ok ? 'stat-icon success' : 'stat-icon error';
      } else {
        document.getElementById('systemHealthStatus').textContent = 'Unknown';
        const icon = document.getElementById('systemHealthIcon');
        if (icon) icon.className = 'stat-icon warning';
      }
    } catch {
      document.getElementById('systemHealthStatus').textContent = 'Error';
      const icon = document.getElementById('systemHealthIcon');
      if (icon) icon.className = 'stat-icon error';
    }
  }

  async function loadRecentActivity() {
    const feed = document.getElementById('activity-feed');
    if (!feed) return;

    feed.innerHTML = '<div class="empty-state"><p style="font-size:0.85rem;">Loading…</p></div>';

    try {
      const r = await fetch('/api/admin/recentActivity?limit=15');
      const d = await r.json();

      if (!d.success || !d.activities?.length) {
        feed.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>';
        return;
      }

      feed.innerHTML = d.activities.map(a => {
        const timeAgo = getTimeAgo(new Date(a.timestamp));
        const cls = { ban: 'error', login: 'primary', registration: 'success', name_change: 'warning' }[a.type] || 'primary';
        const icons = {
          ban: 'M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636',
          login: 'M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9',
          registration: 'M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0z',
          name_change: 'm16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Z'
        };
        return `<div class="activity-item">
          <div class="activity-icon ${cls}">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:0.875rem;height:0.875rem;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${icons[a.type] || icons.login}"></path>
            </svg>
          </div>
          <div class="activity-content">
            <div class="activity-text">${a.description}</div>
            <div class="activity-meta">${a.user.name} · ${timeAgo}</div>
          </div>
        </div>`;
      }).join('');
    } catch {
      feed.innerHTML = '<div class="empty-state"><p>Failed to load activity</p></div>';
    }
  }

  function getTimeAgo(d) {
    const s = Math.floor((Date.now() - d) / 1000);
    if (s < 60) return 'Just now';
    if (s < 3600) { const m = Math.floor(s / 60); return `${m}m ago`; }
    if (s < 86400) { const h = Math.floor(s / 3600); return `${h}h ago`; }
    if (s < 604800) { const dd = Math.floor(s / 86400); return `${dd}d ago`; }
    return d.toLocaleDateString();
  }

  document.getElementById('refreshActivity')?.addEventListener('click', loadRecentActivity);

  let uptimeInterval;
  function init() {
    loadDashboardStats();
    loadRecentActivity();
    uptimeInterval = setInterval(loadServerUptime, 30000);
  }

  window.addEventListener('beforeunload', () => clearInterval(uptimeInterval));

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
