---
import { ClientRouter, fade } from "astro:transitions";
const { pathname } = Astro.url;

// Preload contributor images logic remains same
const GITHUB_REPO = "r5valkyrie/docs";
const GITHUB_BRANCH = "main";
const GITHUB_CONTRIBUTORS_PATH = "contributors";

async function fetchContributorsForPreload(fileName: string) {
  const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/${GITHUB_BRANCH}/${GITHUB_CONTRIBUTORS_PATH}/${fileName}`;
  try {
    const response = await fetch(url);
    if (!response.ok) return [];
    return await response.json();
  } catch (error) {
    console.error(`Error preloading ${fileName}:`, error);
    return [];
  }
}

const [valkyrieContributors, r5reloadedContributors] = await Promise.all([
  fetchContributorsForPreload("contributors.json"),
  fetchContributorsForPreload("r5reloaded_contributors.json"),
]);

const contributorImages = [
  ...valkyrieContributors.map((c: any) => c.avatar),
  ...r5reloadedContributors.map((c: any) => c.avatar),
].filter(Boolean);

interface Props {
  title?: string;
  fullWidth?: boolean;
}

const { title, fullWidth = false } = Astro.props;
const pageTitle = title ? `${title} | Valkyrie` : "Valkyrie";
const customTransition = fade({ duration: "0.5s" });
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <link rel="stylesheet" type="text/css" href="/css/styles.css" />
    <ClientRouter />
    {
      contributorImages.map((imageUrl) => (
        <link rel="preload" href={imageUrl} as="image" />
      ))
    }
  </head>
  <body>
    <div id="bg-fixed"></div>

    <div id="video-bg-container" transition:persist>
      <video autoplay loop muted playsinline>
        <source src="/assets/shortshowcr5v.mp4" type="video/mp4" />
      </video>
      <div class="overlay"></div>
    </div>

    <header class="main-header">
      <a href="/" class="logo">
        <!-- Placeholder for Logo Icon if needed -->
        <span class="text-gradient">R5Valkyrie</span>
      </a>

      <button class="mobile-toggle" aria-label="Toggle Menu">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><line x1="3" y1="12" x2="21" y2="12"></line><line
            x1="3"
            y1="6"
            x2="21"
            y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg
        >
      </button>

      <nav class="main-nav">
        <a href="/" class={`nav-link ${pathname === "/" ? "active" : ""}`}
          >Home</a
        >
        <a
          href="/servers"
          class={`nav-link ${pathname.startsWith("/servers") ? "active" : ""}`}
          >Servers</a
        >
        <a
          href="/mods"
          class={`nav-link ${pathname.startsWith("/mods") ? "active" : ""}`}
          data-astro-prefetch>Mods</a
        >
        <a
          href="/download"
          class={`nav-link ${pathname.startsWith("/download") ? "active" : ""}`}
          >Download</a
        >
        <a
          href="/docs"
          class={`nav-link ${pathname.startsWith("/docs") ? "active" : ""}`}
          >Docs</a
        >
        <a
          href="/contributors"
          class={`nav-link ${pathname.startsWith("/contributors") ? "active" : ""}`}
          >Contributors</a
        >
        <a href="https://discord.gg/GcJSMUGJyD" target="_blank" class="nav-link"
          >Discord</a
        >
      </nav>
    </header>

    <main
      class={!fullWidth ? "main-container" : ""}
      transition:animate={customTransition}
    >
      <slot />
    </main>

    <footer class="main-footer">
      <div class="footer-content">
        <div style="opacity: 0.7;">
          &copy; {new Date().getFullYear()} Valkyrie. All rights reserved.
        </div>
        <div class="footer-links">
          <a href="/eula">EULA</a>
          <a href="https://github.com/r5valkyrie" target="_blank">GitHub</a>
        </div>
      </div>
    </footer>

    <style>
      #video-bg-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2; /* Behind everything */
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
      }

      #video-bg-container.visible {
        opacity: 1;
      }

      #video-bg-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      #video-bg-container .overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(5, 5, 5, 0.7);
        backdrop-filter: blur(3px);
      }
    </style>

    <script>
      function setupMobileMenu() {
        const toggle = document.querySelector(".mobile-toggle");
        const nav = document.querySelector(".main-nav");

        if (toggle && nav) {
          toggle.addEventListener("click", () => {
            nav.classList.toggle("open");
          });
        }
      }

      function setupObserver() {
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("is-visible");
              }
            });
          },
          { threshold: 0.1 },
        );

        document
          .querySelectorAll(".fade-in-on-scroll")
          .forEach((el) => observer.observe(el));
      }

      function updateActiveLinks() {
        const currentPath = window.location.pathname;
        document.querySelectorAll(".nav-link").forEach((link) => {
          const href = link.getAttribute("href");
          if (!href) return;

          let isActive = false;
          if (href === "/") {
            isActive = currentPath === "/";
          } else if (href.startsWith("http")) {
            isActive = false;
          } else {
            isActive = currentPath.startsWith(href);
          }

          if (isActive) {
            link.classList.add("active");
          } else {
            link.classList.remove("active");
          }
        });
      }

      function updateVideoBackground() {
        const videoContainer = document.getElementById("video-bg-container");
        if (videoContainer) {
          if (window.location.pathname === "/") {
            videoContainer.classList.add("visible");
            const video = videoContainer.querySelector("video");
            if (video && video.paused) {
              video.play().catch(() => {});
            }
          } else {
            videoContainer.classList.remove("visible");
          }
        }
      }

      // Expose globally if needed by pages
      (window as any).setupObserver = setupObserver;

      document.addEventListener("DOMContentLoaded", () => {
        setupMobileMenu();
        setupObserver();
        updateVideoBackground();
      });

      document.addEventListener("astro:after-swap", () => {
        setupMobileMenu();
        setupObserver();
        updateActiveLinks();
        updateVideoBackground();
      });
    </script>
  </body>
</html>
